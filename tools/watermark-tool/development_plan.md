# 图片水印工具 - 开发计划

**目标：** 在现有 `watermark_tool.html` 的基础上，增强水印功能，优先实现文本水印的角度调整、平铺模式、自由拖拽定位以及导出格式选择。

## 阶段一：UI 元素添加与调整

1.  **文本水印角度调整：**
    *   在“文字水印设置”区域，添加一个新的 `form-group`。
    *   包含一个 `label` (例如：“角度：”) 和一个 `input type="range"` (例如 `id="textWatermarkAngle"`)，允许用户选择 -90 到 90 度（或0-360度，根据实际需求）。
    *   添加一个 `span` 用于显示当前选择的角度值。
2.  **文本水印位置模式与间隔：**
    *   修改现有的“位置” `select` (`id="textWatermarkPosition"`)，或在其旁边添加新的控件来区分“预设位置”、“平铺模式”和“自由模式”。
        *   一种方案是：保留预设位置的下拉框，额外添加两个按钮：“切换平铺”、“切换自由”。
        *   另一种方案是：将下拉框选项改为：“左上角”、“右上角”...“中心”、“平铺”、“自由”。
    *   在“文字水印设置”区域，添加一个新的 `form-group` 用于“间隔”调整。
    *   包含一个 `label` (例如：“间隔：”) 和一个 `input type="number"` (例如 `id="textWatermarkSpacing"`)，用于平铺模式下的水印间距。
3.  **导出格式选择：**
    *   在“水印预览”区域的下载按钮上方，添加一个新的 `form-group`。
    *   包含一个 `label` (例如：“导出格式：”) 和一个 `select` 元素 (例如 `id="exportFormat"`)，选项包括 "PNG", "JPEG", "JPG"。

## 阶段二：JavaScript 逻辑实现

1.  **获取新增 UI 元素的引用：**
    *   在 `<script>` 标签内，使用 `document.getElementById` 获取新添加的 UI 元素（角度滑块、间隔输入框、导出格式选择框等）。
2.  **实现文本水印角度旋转：**
    *   修改 `drawWatermark()` 函数。
    *   在绘制文本水印之前，获取角度值。
    *   使用 `ctx.save()` 保存当前绘图状态。
    *   使用 `ctx.translate(x + textWidth / 2, y + textHeight / 2)` 将坐标原点移动到文本中心。
    *   使用 `ctx.rotate(angleInRadians)` 进行旋转。
    *   绘制文本时，坐标应相对于新的原点 (例如 `ctx.fillText(text, -textWidth / 2, -textHeight / 2)` )。
    *   使用 `ctx.restore()` 恢复绘图状态。
3.  **实现文本水印平铺模式：**
    *   在 `drawWatermark()` 函数中，增加对“平铺”模式的逻辑判断。
    *   如果选择了平铺模式：
        *   获取间隔值。
        *   使用嵌套循环，在整个 Canvas 画布上重复绘制文本水印。
        *   计算每个水印的位置时，要考虑文本宽度、高度以及间隔。
        *   旋转逻辑也需要应用于每个平铺的水印。
4.  **实现文本水印自由拖拽定位：**
    *   此功能相对复杂，需要事件监听 (mousedown, mousemove, mouseup) 来处理拖拽。
    *   当选择“自由”模式时：
        *   在 `mousedown` 事件中，判断鼠标点击位置是否在当前文本水印的包围盒内。
        *   如果是，则记录起始拖拽位置和鼠标与水印左上角的偏移。
        *   在 `mousemove` 事件中，如果正在拖拽，则更新水印的 `x, y` 坐标，并重新调用 `drawWatermark()`。
        *   在 `mouseup` 事件中，结束拖拽。
    *   需要维护文本水印的当前 `x, y` 坐标变量。
5.  **实现导出格式选择：**
    *   修改下载按钮 `downloadImageBtn` 的事件监听器。
    *   获取用户选择的导出格式。
    *   根据选择的格式，调用 `watermarkCanvas.toDataURL()` 时传入相应的 MIME 类型 (例如 `'image/png'`, `'image/jpeg'`)。
    *   相应地修改下载链接的文件名后缀。
6.  **更新事件监听器：**
    *   将新添加的 UI 元素（角度、间隔等）也加入到实时预览的事件监听数组中 (`element.addEventListener('input', drawWatermark)`)。

## 阶段三：测试与优化

1.  **功能测试：**
    *   测试文本角度调整是否正常。
    *   测试平铺模式下水印是否按预期排列和间隔。
    *   测试自由拖拽定位是否流畅准确。
    *   测试不同导出格式是否能成功下载并保持质量。
2.  **兼容性测试：** 在主流浏览器中测试。
3.  **代码优化：** 检查代码逻辑，进行必要的优化。

## Mermaid 图示 (简化流程)

```mermaid
graph TD
    A[用户操作界面] --> B{获取用户输入};
    B -- 上传图片 --> C[加载原图];
    B -- 调整文本水印参数 --> D{处理文本水印};
    D -- 角度 --> E[计算旋转];
    D -- 内容/字体/大小/颜色 --> F[设置文本样式];
    D -- 位置模式 --> G{判断位置模式};
    G -- 预设位置 --> H[计算预设坐标];
    G -- 平铺模式 --> I[计算平铺坐标与间隔];
    G -- 自由模式 --> J[处理拖拽更新坐标];
    C --> K[绘制原图到Canvas];
    E --> L[应用旋转];
    F --> L;
    H --> L;
    I --> L;
    J --> L;
    L --> M[绘制文本水印到Canvas];
    B -- 调整图片水印参数 --> N{处理图片水印};
    N --> O[绘制图片水印到Canvas];
    M --> P[预览更新];
    O --> P;
    B -- 选择导出格式 --> Q[设置导出参数];
    P --> R{用户点击下载};
    Q --> R;
    R --> S[生成并下载图片];