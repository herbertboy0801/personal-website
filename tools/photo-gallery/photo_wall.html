<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊÉÖ‰æ£ÁÖßÁâáÂ¢ô - ÂàÜÈ°µ‰∏éÁºñËæë</title>
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Arial', sans-serif; color: #333;
        }
        body {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
            display: flex; flex-direction: column; align-items: center;
        }
        .container {
            width: 100vw; height: 100vh; max-width: none; 
            background-color: rgba(255, 255, 255, 0.85); 
            padding: 10px; border-radius: 0; box-shadow: none; 
            box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; 
        }
        h1 {
            color: #c70039; text-align: center; margin: 10px 0 15px 0; 
            font-size: 1.8em; position: relative; z-index: 10; flex-shrink: 0; 
        }
        #controlsHeader {
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out, margin-bottom 0.3s ease-in-out;
            overflow: hidden; max-height: 500px; opacity: 1; margin-bottom: 15px; 
            position: relative; z-index: 10; background-color: rgba(255, 255, 255, 0.8); 
            padding-top: 5px; padding-bottom: 5px; border-radius: 5px; flex-shrink: 0; 
        }
        #controlsHeader.hidden {
            max-height: 0; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; 
            margin-bottom: 0 !important; border-top: none; border-bottom: none; 
        }
        .controls, .music-controls {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; 
        }
        .music-controls { padding: 8px 0; align-items: center; }
        .music-controls label, .music-controls input[type="file"] { margin-right: 5px; }
        #customMusicUpload { 
            padding: 6px; border-radius: 4px; border: 1px solid #ccc;
            background-color: #fff; font-size: 0.9em; max-width: 180px; 
        }
        .controls input[type="file"]#photoUpload, 
        .controls button, .controls select,
        .music-controls select, .music-controls button, .music-controls input[type="range"] {
            padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;
            background-color: #fff; cursor: pointer; font-size: 0.95em; 
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .music-controls input[type="range"] { padding: 0; height: 18px; flex-grow: 0.5; min-width: 100px; }
        .controls input[type="file"]#photoUpload { flex-grow: 1; min-width: 150px; }
        .controls button:hover, .controls select:hover,
        .music-controls select:hover, .music-controls button:hover, #customMusicUpload:hover {
            background-color: #f0f0f0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .photo-wall-area { 
            display: flex; align-items: center; justify-content: center; 
            width: 100%; flex-grow: 1; min-height: 0; 
            position: relative; z-index: 1; padding-top: 20px; box-sizing: border-box; 
        }
        .photo-wall-nav-btn {
            background-color: rgba(50, 50, 50, 0.5); color: white; border: none;
            border-radius: 50%; width: 40px; height: 40px; font-size: 20px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            margin: 0 10px; z-index: 5; transition: background-color 0.2s;
        }
        .photo-wall-nav-btn:hover { background-color: rgba(80, 80, 80, 0.8); }
        .photo-wall-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .photo-wall-container {
            display: grid; gap: 8px; width: 100%; max-width: 900px; 
            height: 100%; overflow-y: auto; padding-bottom: 10px; 
            transition: grid-template-columns 0.5s ease-in-out;
        }
        .photo-item {
            position: relative; overflow: hidden; border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out, border-radius 0.3s ease-in-out; 
            cursor: pointer; background-color: #eee; aspect-ratio: 1 / 1; 
        }
        .photo-item img {
            display: block; width: 100%; height: 100%;
            object-fit: cover; transition: transform 0.3s ease-in-out;
        }
        .photo-item:hover img { transform: scale(1.1); }
        .photo-item .info {
            position: absolute; bottom: 0; left: 0; right: 0;
            background-color: rgba(0, 0, 0, 0.6); color: white;
            padding: 5px; font-size: 0.8em; text-align: center;
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
        }
        .photo-item:hover .info { opacity: 1; }

        .photo-wall-container.layout-1 { grid-template-columns: 1fr; }
        .photo-wall-container.layout-2 { grid-template-columns: repeat(2, 1fr); }
        .photo-wall-container.layout-4 { grid-template-columns: repeat(2, 1fr); } 
        .photo-wall-container.layout-6 { grid-template-columns: repeat(3, 1fr); } 
        .photo-wall-container.layout-8 { grid-template-columns: repeat(4, 1fr); } 
        .photo-wall-container.layout-1 .photo-item { aspect-ratio: 16 / 9; }

        @media (max-width: 768px) {
            h1 { font-size: 1.5em; margin-bottom: 10px; }
            #controlsHeader { margin-bottom: 10px; }
            .controls, .music-controls { gap: 5px; }
            .controls input[type="file"]#photoUpload, .controls button, .controls select,
            .music-controls select, .music-controls button, .music-controls input[type="range"],
            #customMusicUpload { 
                font-size: 0.9em; padding: 6px 10px; width: calc(50% - 10px); 
                margin-bottom: 5px; box-sizing: border-box;
            }
            .controls input[type="file"]#photoUpload { width: calc(100% - 20px); } 
            .photo-wall-container.layout-6 { grid-template-columns: repeat(2, 1fr); } 
            .photo-wall-container.layout-8 { grid-template-columns: repeat(2, 1fr); } 
        }
         @media (max-width: 480px) {
            .photo-wall-container.layout-4,
            .photo-wall-container.layout-6,
            .photo-wall-container.layout-8 { grid-template-columns: repeat(2, 1fr) !important; }
            .controls input[type="file"]#photoUpload, .controls button, .controls select,
            .music-controls select, .music-controls button, .music-controls input[type="range"],
            #customMusicUpload { width: calc(100% - 10px); }
            .photo-wall-nav-btn { width:30px; height:30px; font-size:16px; margin: 0 5px;}
        }
        
        .photo-item.loading { opacity: 0; transform: scale(0.8); }
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); display: flex;
            justify-content: center; align-items: center; z-index: 10000; 
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-dialog-content { 
            position: relative; background-color: #333; 
            padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            max-width: 90vw; max-height: 90vh; display: flex;
            flex-direction: column; align-items: center; color: white;
            animation: modal-fade-in 0.3s ease-out;
        }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .modal-image {
            max-width: 100%; max-height: calc(90vh - 160px); 
            object-fit: contain; border-radius: 8px;
            margin-bottom: 10px; transition: opacity 0.5s ease-in-out; 
        }
        .modal-close-btn { 
            position: absolute; top: 10px; right: 15px;
            background: none; border: none; color: white;
            font-size: 28px; line-height: 1; cursor: pointer; opacity: 0.7;
        }
        .modal-close-btn:hover { opacity: 1; }

        .fullscreen-modal-nav { 
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(50, 50, 50, 0.7); color: white; border: none;
            border-radius: 50%; cursor: pointer; font-size: 24px; 
            width: 40px; height: 40px; display: flex;
            justify-content: center; align-items: center;
            transition: background-color 0.2s, opacity 0.2s; user-select: none;
        }
        .fullscreen-modal-nav:hover { background-color: rgba(80, 80, 80, 0.9); }
        .fullscreen-modal-nav.disabled, .fullscreen-modal-nav.slideshow-disabled { opacity: 0.3; cursor: not-allowed; }
        #modalPrevBtnFs { left: 15px; } #modalNextBtnFs { right: 15px; }
        
        .modal-info-area { display: flex; flex-direction: column; align-items: center; width: 100%;}
        .modal-info {
            text-align: left; padding: 5px 10px; background-color: rgba(0,0,0,0.6); 
            border-radius: 5px; font-size: 0.9em; max-width: 80%; 
            max-height: 80px; overflow-y: auto; line-height: 1.5; margin-bottom: 10px;
        }
        .modal-info strong { color: #ffc107; }
        #editPhotoBtnModal {
            background-color: #5bc0de; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-top: 5px;
        }
        #editPhotoBtnModal:hover { background-color: #31b0d5; }

        #editPhotoInfoModal .modal-dialog-content { width: 400px; max-width: 90vw; } /* Adjusted from edit-modal-content */
        #editPhotoInfoModal h2 { margin-top: 0; color: #f0ad4e; }
        #editPhotoInfoModal div:not(.edit-actions) { margin-bottom: 15px; width:100%; } /* Target form groups */
        #editPhotoInfoModal label { display: block; margin-bottom: 5px; font-weight: bold; }
        #editPhotoInfoModal input[type="text"], #editPhotoInfoModal textarea {
            width: calc(100% - 22px); 
            padding: 10px; border-radius: 4px; border: 1px solid #666;
            background-color: #444; color: white; font-size: 1em; box-sizing: border-box;
        }
        #editPhotoInfoModal textarea { resize: vertical; min-height: 60px; }
        #editPhotoInfoModal .edit-actions { margin-top: 20px; text-align: right; width:100%;}
        #editPhotoInfoModal .edit-actions button {
            padding: 10px 20px; margin-left: 10px; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold;
        }
        #savePhotoInfoBtn { background-color: #5cb85c; color: white; }
        #savePhotoInfoBtn:hover { background-color: #4cae4c; }
        #cancelEditPhotoInfoBtn { background-color: #f0f0f0; color: #333; }
        #cancelEditPhotoInfoBtn:hover { background-color: #e0e0e0; }


        .border-default { border-radius: 8px; } 
        .border-square { border-radius: 0; }
        .border-circle { border-radius: 50%; } 
        .border-heart {
            clip-path: polygon(50% 100%, 0 45%, 0 15%, 20% 0, 50% 20%, 80% 0, 100% 15%, 100% 45%);
            border-radius: 0; 
        }
        .border-none { border: none; box-shadow: none; border-radius: 0; }
        #toggleControlsBtn {
            position: fixed; top: 10px; right: 10px; z-index: 9999; 
            padding: 8px 12px; background-color: #c70039; color: white;
            border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #toggleControlsBtn:hover { background-color: #a5002d; }
    </style>
</head>
<body>
    <button id="toggleControlsBtn">ÈöêËóèÊéß‰ª∂</button>
    <div class="container">
        <h1>üíñ ÊÉÖ‰æ£ÁÖßÁâáÂ¢ô üíñ</h1>
        <div id="controlsHeader">
            <div class="controls">
                <input type="file" id="photoUpload" accept="image/*" multiple title="ÈÄâÊã©ÁÖßÁâá">
                <button id="layoutBtn1">1ÂÆ´Ê†º</button>
                <button id="layoutBtn2">2ÂÆ´Ê†º</button>
                <button id="layoutBtn4">4ÂÆ´Ê†º</button>
                <button id="layoutBtn6">6ÂÆ´Ê†º</button>
                <button id="layoutBtn8">8ÂÆ´Ê†º</button>
                <select id="backgroundSelector">
                    <option value="gradient1">ÈªòËÆ§Ê∏êÂèò</option>
                    <option value="gradient2">Ê∏©È¶®Á≤â</option>
                    <option value="hearts">Áà±ÂøÉÂõæÊ°à</option>
                    <option value="custom">Ëá™ÂÆö‰πâËÉåÊôØÂõæ</option>
                </select>
                <input type="file" id="customBgUpload" accept="image/*" style="display:none;" title="‰∏ä‰º†Ëá™ÂÆö‰πâËÉåÊôØ">
                 <select id="borderStyleSelector" title="ÈÄâÊã©ÁÖßÁâáËæπÊ°ÜÊ†∑Âºè">
                    <option value="border-default">ÈªòËÆ§ÂúÜËßí</option>
                    <option value="border-square">ÊñπËßí</option>
                    <option value="border-circle">ÂúÜÂΩ¢</option>
                    <option value="border-heart">ÂøÉÂΩ¢</option>
                    <option value="border-none">Êó†ËæπÊ°Ü</option>
                </select>
                <button id="startSlideshowBtn">Êí≠ÊîæÂπªÁÅØÁâá</button>
            </div>
            <div class="music-controls">
                <label for="musicSelector" style="color: #c70039; font-weight: bold;">È¢ÑËÆæÈü≥‰πê:</label>
                <select id="musicSelector">
                    <option value="">ÈÄâÊã©Èü≥‰πê</option>
                </select>
                <button id="playPauseMusicBtn">Êí≠ÊîæÈü≥‰πê</button>
                <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5" title="Èü≥Èáè">
                <label for="customMusicUpload" style="color: #c70039; font-weight: bold; margin-left:10px;">Ëá™ÂÆö‰πâ:</label>
                <input type="file" id="customMusicUpload" accept="audio/*" title="‰∏ä‰º†Ëá™ÂÆö‰πâÈü≥‰πê">
            </div>
        </div>

        <div class="photo-wall-area">
            <button id="prevPageBtn" class="photo-wall-nav-btn" title="‰∏ä‰∏ÄÈ°µ">&#10094;</button>
            <div id="photoWall" class="photo-wall-container layout-4"></div>
            <button id="nextPageBtn" class="photo-wall-nav-btn" title="‰∏ã‰∏ÄÈ°µ">&#10095;</button>
        </div>
    </div>

    <div id="fullscreenPhotoModal" class="modal-overlay">
        <div class="modal-dialog-content">
            <button id="modalCloseBtnFs" class="modal-close-btn" title="ÂÖ≥Èó≠ (Esc)">&times;</button>
            <img id="modalImageFs" class="modal-image" src="" alt="ÂÖ®Â±èÁÖßÁâá">
            <div class="modal-info-area">
                <div id="modalInfoFs" class="modal-info"></div>
                <button id="editPhotoBtnModal">ÁºñËæë‰ø°ÊÅØ</button>
            </div>
            <button id="modalPrevBtnFs" class="fullscreen-modal-nav" title="‰∏ä‰∏ÄÂº† (‚Üê)">&#10094;</button>
            <button id="modalNextBtnFs" class="fullscreen-modal-nav" title="‰∏ã‰∏ÄÂº† (‚Üí)">&#10095;</button>
        </div>
    </div>

    <div id="editPhotoInfoModal" class="modal-overlay">
        <div class="modal-dialog-content"> {/* Reused class for consistent modal appearance */}
            <button id="closeEditModalBtn" class="modal-close-btn" title="ÂÖ≥Èó≠">&times;</button>
            <h2>ÁºñËæëÁÖßÁâá‰ø°ÊÅØ</h2>
            <input type="hidden" id="editingPhotoIndex">
            <div>
                <label for="editLocation">Âú∞ÁÇπ:</label>
                <input type="text" id="editLocation">
            </div>
            <div>
                <label for="editLoveMemory">Áà±ÁöÑËÆ∞ÂøÜ:</label>
                <textarea id="editLoveMemory" rows="3"></textarea>
            </div>
            <div>
                <label for="editDescription">ÊèèËø∞:</label>
                <textarea id="editDescription" rows="2"></textarea>
            </div>
            <div class="edit-actions">
                <button id="savePhotoInfoBtn">‰øùÂ≠òÊõ¥Êîπ</button>
                <button id="cancelEditPhotoInfoBtn">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <audio id="backgroundAudio" loop></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const photoUpload = document.getElementById('photoUpload');
            const photoWall = document.getElementById('photoWall');
            
            const layoutButtonConfigs = [
                { id: 'layoutBtn1', photosPerPage: 1, className: 'layout-1' },
                { id: 'layoutBtn2', photosPerPage: 2, className: 'layout-2' },
                { id: 'layoutBtn4', photosPerPage: 4, className: 'layout-4' },
                { id: 'layoutBtn6', photosPerPage: 6, className: 'layout-6' },
                { id: 'layoutBtn8', photosPerPage: 8, className: 'layout-8' },
            ];

            const backgroundSelector = document.getElementById('backgroundSelector');
            const customBgUpload = document.getElementById('customBgUpload');
            const borderStyleSelector = document.getElementById('borderStyleSelector');
            const startSlideshowBtn = document.getElementById('startSlideshowBtn');
            const controlsHeader = document.getElementById('controlsHeader');
            const toggleControlsBtn = document.getElementById('toggleControlsBtn');
            const backgroundAudio = document.getElementById('backgroundAudio');
            const musicSelector = document.getElementById('musicSelector');
            const playPauseMusicBtn = document.getElementById('playPauseMusicBtn');
            const volumeControl = document.getElementById('volumeControl');
            const customMusicUpload = document.getElementById('customMusicUpload');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');

            const fullscreenPhotoModal = document.getElementById('fullscreenPhotoModal');
            const modalCloseBtnFs = document.getElementById('modalCloseBtnFs');
            const modalImageFs = document.getElementById('modalImageFs');
            const modalInfoFs = document.getElementById('modalInfoFs');
            const modalPrevBtnFs = document.getElementById('modalPrevBtnFs');
            const modalNextBtnFs = document.getElementById('modalNextBtnFs');
            const editPhotoBtnModal = document.getElementById('editPhotoBtnModal');

            const editPhotoInfoModal = document.getElementById('editPhotoInfoModal');
            const closeEditModalBtn = document.getElementById('closeEditModalBtn');
            const editingPhotoIndexInput = document.getElementById('editingPhotoIndex');
            const editLocationInput = document.getElementById('editLocation');
            const editLoveMemoryInput = document.getElementById('editLoveMemory');
            const editDescriptionInput = document.getElementById('editDescription');
            const savePhotoInfoBtn = document.getElementById('savePhotoInfoBtn');
            const cancelEditPhotoInfoBtn = document.getElementById('cancelEditPhotoInfoBtn');

            let uploadedFiles = [];
            let currentFullScreenIndex = -1; 
            
            let slideshowIntervalId = null;
            let isSlideshowPlaying = false;
            const slideshowDelay = 3000; 

            let currentPage = 0;
            let currentPhotosPerPage = 4; 
            let currentLayoutClass = 'layout-4'; 

            const presetMusic = [
                { name: "Êµ™Êº´Èí¢Áê¥Êõ≤", path: "music/romantic_piano.mp3" }, 
                { name: "Ê∏©È¶®Âêâ‰ªñ", path: "music/gentle_guitar.mp3" },   
                { name: "ËΩªÂø´Â∞èË∞É", path: "music/upbeat_melody.mp3" }
            ];
            const defaultLocations = ["Áà±ÁöÑÂ∞èÁ™ù", "ÊóÖÈÄî‰∏≠ÁöÑÊÉäÂñú", "Êüê‰∏™Èò≥ÂÖâÁÅøÁÉÇÁöÑÊó•Â≠ê", "ÁßòÂØÜÊçÆÁÇπ", "ÂõûÂøÜÁöÑËßíËêΩ", "Ê∏©È¶®Â∞èÂ±ã", "Êµ™Êº´Êµ∑Êª©", "Â±±È°∂ÁöÑÁ∫¶ÂÆö"];
            const defaultMemories = ["ÊØè‰∏ÄÂàªÈÉΩÂÄºÂæóÁèçËóè", "ÂøÉÂä®ÁöÑÊÑüËßâ", "ÁîúËúúÊó∂ÂÖâ", "Âπ∏Á¶èÁû¨Èó¥", "Êàë‰ª¨ÁöÑÊïÖ‰∫ã", "Ê∞∏ÊÅíÁöÑÁà±", "‰∏ÄËßÅÈíüÊÉÖ", "Êê∫ÊâãÂà∞ËÄÅ"];

            function populateMusicSelector() { 
                presetMusic.forEach(music => {
                    const option = document.createElement('option');
                    option.value = music.path; option.textContent = music.name;
                    musicSelector.appendChild(option);
                });
            }

            toggleControlsBtn.addEventListener('click', () => { 
                controlsHeader.classList.toggle('hidden');
                toggleControlsBtn.textContent = controlsHeader.classList.contains('hidden') ? 'ÊòæÁ§∫Êéß‰ª∂' : 'ÈöêËóèÊéß‰ª∂';
                if (!controlsHeader.classList.contains('hidden')) {
                    requestAnimationFrame(() => {
                        photoWall.style.display = 'none'; photoWall.offsetHeight; photoWall.style.display = 'grid'; 
                    });
                }
            });
            
            photoUpload.addEventListener('change', (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                const newFilesPromises = files.filter(f => f.type.startsWith('image/')).map(file => {
                    return new Promise(resolve => {
                        const randomLocation = defaultLocations[Math.floor(Math.random() * defaultLocations.length)];
                        const randomMemory = defaultMemories[Math.floor(Math.random() * defaultMemories.length)];
                        const reader = new FileReader();
                        reader.onload = (e) => resolve({
                            src: e.target.result, name: file.name, date: new Date().toLocaleDateString(),
                            description: `ÂÖ≥‰∫é ${file.name.split('.')[0]} ÁöÑÁæéÂ•ΩÂõûÂøÜ~`,
                            location: randomLocation, loveMemory: randomMemory
                        });
                        reader.readAsDataURL(file);
                    });
                });
                Promise.all(newFilesPromises).then(newPhotoData => {
                    uploadedFiles.push(...newPhotoData);
                    currentPage = 0; 
                    renderCurrentPagePhotos();
                });
            });

            function createPhotoItem(fileData, pageSpecificIndex) { 
                const photoItem = document.createElement('div');
                photoItem.classList.add('photo-item', 'loading');
                const currentBorderStyle = borderStyleSelector.value || 'border-default';
                if (currentBorderStyle) photoItem.classList.add(currentBorderStyle);
                const globalIndex = uploadedFiles.indexOf(fileData);
                photoItem.dataset.index = globalIndex; 
                const img = document.createElement('img');
                img.src = fileData.src; img.alt = fileData.name;
                const info = document.createElement('div');
                info.classList.add('info');
                info.textContent = `${fileData.location.substring(0,10)}...`;
                photoItem.appendChild(img); photoItem.appendChild(info);
                setTimeout(() => photoItem.classList.remove('loading'), 100 * (pageSpecificIndex % currentPhotosPerPage)); 
                photoItem.addEventListener('click', () => { if (!isSlideshowPlaying) openFullScreenModal(globalIndex); });
                return photoItem;
            }

            function renderCurrentPagePhotos() {
                photoWall.innerHTML = ''; 
                if (uploadedFiles.length === 0) {
                    updatePageNavButtons(); return;
                }
                const startIndex = currentPage * currentPhotosPerPage;
                const endIndex = Math.min(startIndex + currentPhotosPerPage, uploadedFiles.length);
                const photosToRender = uploadedFiles.slice(startIndex, endIndex);
                photosToRender.forEach((fileData, pageIndex) => { 
                    photoWall.appendChild(createPhotoItem(fileData, pageIndex));
                });
                updatePageNavButtons();
            }

            function updatePageNavButtons() {
                prevPageBtn.disabled = currentPage === 0 || uploadedFiles.length === 0;
                const totalPages = Math.ceil(uploadedFiles.length / currentPhotosPerPage);
                nextPageBtn.disabled = currentPage >= totalPages - 1 || uploadedFiles.length === 0 || totalPages <=1 ;
            }

            prevPageBtn.addEventListener('click', () => { if (currentPage > 0) { currentPage--; renderCurrentPagePhotos(); } });
            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(uploadedFiles.length / currentPhotosPerPage);
                if (currentPage < totalPages - 1) { currentPage++; renderCurrentPagePhotos(); }
            });
            
            layoutButtonConfigs.forEach(config => {
                const button = document.getElementById(config.id);
                if (button) {
                    button.addEventListener('click', () => {
                        currentPhotosPerPage = config.photosPerPage;
                        currentLayoutClass = config.className;
                        photoWall.className = 'photo-wall-container'; 
                        photoWall.classList.add(currentLayoutClass);
                        photoWall.style.position = 'relative'; photoWall.style.zIndex = '1'; photoWall.style.minHeight = '0';
                        currentPage = 0; renderCurrentPagePhotos();
                    });
                }
            });
            
            backgroundSelector.addEventListener('change', (event) => applyBackground(event.target.value));
            customBgUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.body.style.backgroundImage = `url(${e.target.result})`;
                        document.body.style.backgroundSize = 'cover'; document.body.style.backgroundPosition = 'center';
                        document.body.style.backgroundAttachment = 'fixed'; document.body.style.backgroundBlendMode = ''; 
                        document.body.style.backgroundColor = ''; 
                    }
                    reader.readAsDataURL(file);
                }
            });
            function applyBackground(backgroundType) {
                customBgUpload.style.display = 'none';
                document.body.style.backgroundImage = ''; document.body.style.backgroundBlendMode = '';
                document.body.style.backgroundAttachment = '';
                switch (backgroundType) {
                    case 'gradient1': document.body.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%)'; break;
                    case 'gradient2': document.body.style.background = 'linear-gradient(to right, #ffecd2 0%, #fcb69f 100%)'; break;
                    case 'hearts':
                        document.body.style.backgroundColor = '#ffe0e0';
                        document.body.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cpath d='M30 20c-5.523 0-10 4.477-10 10 0 8.837 10 15 10 15s10-6.163 10-15c0-5.523-4.477-10-10-10z' fill='%23ff7979' fill-opacity='0.3'/%3E%3C/svg%3E")`;
                        document.body.style.backgroundRepeat = 'repeat'; break;
                    case 'custom': customBgUpload.style.display = 'inline-block'; break;
                }
            }
            borderStyleSelector.addEventListener('change', (event) => { 
                 const newBorderStyleClass = event.target.value;
                const photoItems = photoWall.querySelectorAll('.photo-item'); 
                photoItems.forEach(item => {
                    item.className = item.className.replace(/\bborder-\w+\b/g, '').trim(); 
                    if (newBorderStyleClass && newBorderStyleClass !== "") item.classList.add(newBorderStyleClass);
                });
            });
            
            modalCloseBtnFs.addEventListener('click', closeFullScreenModal);
            modalPrevBtnFs.addEventListener('click', () => showPrevImageFs());
            modalNextBtnFs.addEventListener('click', () => showNextImageFs());
            editPhotoBtnModal.addEventListener('click', () => {
                if (currentFullScreenIndex !== -1) {
                    openEditInfoModal(currentFullScreenIndex);
                }
            });

            function openFullScreenModal(index) {
                if (uploadedFiles.length === 0 || index < 0 || index >= uploadedFiles.length) return;
                currentFullScreenIndex = index; 
                displayFullScreenImage(); 
                fullscreenPhotoModal.classList.add('active'); 
                document.addEventListener('keydown', handleFullScreenKeyPress);
                if (isSlideshowPlaying) {
                    modalPrevBtnFs.classList.add('slideshow-disabled'); modalNextBtnFs.classList.add('slideshow-disabled');
                } else {
                    modalPrevBtnFs.classList.remove('slideshow-disabled'); modalNextBtnFs.classList.remove('slideshow-disabled');
                }
            }
            function closeFullScreenModal() {
                 if (fullscreenPhotoModal) fullscreenPhotoModal.classList.remove('active');
                document.removeEventListener('keydown', handleFullScreenKeyPress);
                if (isSlideshowPlaying) stopSlideshow();
                currentFullScreenIndex = -1; 
            }
            function displayFullScreenImage() {
                if (currentFullScreenIndex === -1 || uploadedFiles.length === 0 || !fullscreenPhotoModal) return;
                const photoData = uploadedFiles[currentFullScreenIndex]; 
                const newInfoHTML = `<strong>Êó•Êúü:</strong> ${photoData.date}<br><strong>Âú∞ÁÇπ:</strong> ${photoData.location}<br><strong>Áà±ÁöÑËÆ∞ÂøÜ:</strong> ${photoData.loveMemory}<br><strong>ÊèèËø∞:</strong> ${photoData.description}`;
                if (isSlideshowPlaying) {
                    modalImageFs.style.opacity = 0; 
                    setTimeout(() => {
                        modalImageFs.src = photoData.src; modalImageFs.alt = photoData.name;
                        modalInfoFs.innerHTML = newInfoHTML; modalImageFs.style.opacity = 1; 
                    }, 250); 
                } else {
                    modalImageFs.src = photoData.src; modalImageFs.alt = photoData.name;
                    modalInfoFs.innerHTML = newInfoHTML;
                }
                if (!isSlideshowPlaying) {
                    modalPrevBtnFs.disabled = uploadedFiles.length <= 1 || currentFullScreenIndex === 0; 
                    modalNextBtnFs.disabled = uploadedFiles.length <= 1 || currentFullScreenIndex === uploadedFiles.length - 1;
                }
            }
            function showNextImageFs() { 
                if (uploadedFiles.length === 0 || isSlideshowPlaying) return;
                if (currentFullScreenIndex < uploadedFiles.length - 1) {
                    currentFullScreenIndex++; displayFullScreenImage();
                }
            }
            function showPrevImageFs() {
                if (uploadedFiles.length === 0 || isSlideshowPlaying) return;
                if (currentFullScreenIndex > 0) {
                    currentFullScreenIndex--; displayFullScreenImage();
                }
            }
            function handleFullScreenKeyPress(event) {
                if (!fullscreenPhotoModal.classList.contains('active')) return;
                switch (event.key) {
                    case 'Escape': closeFullScreenModal(); break;
                    case 'ArrowRight': if (!isSlideshowPlaying && !modalNextBtnFs.disabled) showNextImageFs(); break;
                    case 'ArrowLeft': if (!isSlideshowPlaying && !modalPrevBtnFs.disabled) showPrevImageFs(); break;
                }
            }
            
            function toggleSlideshow() {
                if (uploadedFiles.length === 0) { alert("ËØ∑ÂÖà‰∏ä‰º†ÁÖßÁâáÂÜçÊí≠ÊîæÂπªÁÅØÁâá„ÄÇ"); return; }
                if (isSlideshowPlaying) stopSlideshow(); else startSlideshow();
            }
            function startSlideshow() {
                isSlideshowPlaying = true; startSlideshowBtn.textContent = 'ÊöÇÂÅúÂπªÁÅØÁâá';
                let initialSlideshowIndex = uploadedFiles.indexOf(uploadedFiles[currentPage * currentPhotosPerPage]) ;
                if(initialSlideshowIndex < 0 || initialSlideshowIndex >= uploadedFiles.length) initialSlideshowIndex = 0;

                if (!fullscreenPhotoModal.classList.contains('active')) {
                     if(uploadedFiles.length > 0) openFullScreenModal(initialSlideshowIndex); else return;
                } else { currentFullScreenIndex = initialSlideshowIndex; }

                modalPrevBtnFs.classList.add('slideshow-disabled'); modalNextBtnFs.classList.add('slideshow-disabled');
                displayFullScreenImage(); 
                slideshowIntervalId = setInterval(() => { 
                     currentFullScreenIndex = (currentFullScreenIndex + 1) % uploadedFiles.length; displayFullScreenImage(); 
                }, slideshowDelay);
            }
            function stopSlideshow() {
                clearInterval(slideshowIntervalId); isSlideshowPlaying = false;
                startSlideshowBtn.textContent = 'Êí≠ÊîæÂπªÁÅØÁâá';
                if (fullscreenPhotoModal) { 
                    modalPrevBtnFs.classList.remove('slideshow-disabled'); modalNextBtnFs.classList.remove('slideshow-disabled');
                    if (fullscreenPhotoModal.classList.contains('active') && currentFullScreenIndex !== -1) { 
                         modalPrevBtnFs.disabled = uploadedFiles.length <= 1 || currentFullScreenIndex === 0;
                         modalNextBtnFs.disabled = uploadedFiles.length <= 1 || currentFullScreenIndex === uploadedFiles.length -1;
                    }
                }
            }
            startSlideshowBtn.addEventListener('click', toggleSlideshow);

            closeEditModalBtn.addEventListener('click', () => editPhotoInfoModal.classList.remove('active'));
            cancelEditPhotoInfoBtn.addEventListener('click', () => editPhotoInfoModal.classList.remove('active'));

            function openEditInfoModal(index) {
                if (index < 0 || index >= uploadedFiles.length) return;
                const photoData = uploadedFiles[index];
                editingPhotoIndexInput.value = index;
                editLocationInput.value = photoData.location;
                editLoveMemoryInput.value = photoData.loveMemory;
                editDescriptionInput.value = photoData.description;
                editPhotoInfoModal.classList.add('active');
            }

            savePhotoInfoBtn.addEventListener('click', () => {
                const indexToEdit = parseInt(editingPhotoIndexInput.value);
                if (isNaN(indexToEdit) || indexToEdit < 0 || indexToEdit >= uploadedFiles.length) return;

                uploadedFiles[indexToEdit].location = editLocationInput.value;
                uploadedFiles[indexToEdit].loveMemory = editLoveMemoryInput.value;
                uploadedFiles[indexToEdit].description = editDescriptionInput.value;

                editPhotoInfoModal.classList.remove('active');
                renderCurrentPagePhotos(); 
                if (fullscreenPhotoModal.classList.contains('active') && currentFullScreenIndex === indexToEdit) {
                    displayFullScreenImage(); 
                }
            });
            
            musicSelector.addEventListener('change', function() { 
                const selectedPath = this.value; console.log("È¢ÑËÆæÈü≥‰πêÈÄâÊã©:", selectedPath);
                if (selectedPath) {
                    backgroundAudio.src = selectedPath; console.log("Audio src ËÆæÁΩÆ‰∏∫ (È¢ÑËÆæ):", backgroundAudio.src);
                    backgroundAudio.load(); backgroundAudio.play().catch(e => console.warn("ÈÄâÊã©È¢ÑËÆæÈü≥‰πêÂêéËá™Âä®Êí≠ÊîæÂ§±Ë¥•:", e.message));
                } else { backgroundAudio.pause(); backgroundAudio.src = ""; playPauseMusicBtn.textContent = 'Êí≠ÊîæÈü≥‰πê'; }
            });
            playPauseMusicBtn.addEventListener('click', function() {
                console.log("Êí≠Êîæ/ÊöÇÂÅúÊåâÈíÆÁÇπÂáª„ÄÇÂΩìÂâç src:", backgroundAudio.src, "Paused:", backgroundAudio.paused, "Selector value:", musicSelector.value);
                if (!backgroundAudio.src && musicSelector.value) { 
                    backgroundAudio.src = musicSelector.value; console.log("‰ªéÈÄâÊã©Âô®ËÆæÁΩÆ Audio src:", backgroundAudio.src); backgroundAudio.load();
                } else if (!backgroundAudio.src && !(customMusicUpload.files && customMusicUpload.files.length > 0 && backgroundAudio.src.startsWith('blob:'))) {
                     alert("ËØ∑ÂÖàÈÄâÊã©‰∏ÄÈ¶ñÈ¢ÑËÆæÈü≥‰πêÊàñ‰∏ä‰º†Ëá™ÂÆö‰πâÈü≥‰πê„ÄÇ"); return;
                }
                if (backgroundAudio.paused) {
                    if (!backgroundAudio.src) { alert("Ê≤°ÊúâÂèØÊí≠ÊîæÁöÑÈü≥‰πêÊ∫ê„ÄÇ"); return; }
                    console.log("Â∞ùËØïÊí≠Êîæ:", backgroundAudio.src);
                    backgroundAudio.play().catch(e => { console.error("Èü≥‰πêÊí≠ÊîæÊó∂ÂèëÁîüÈîôËØØ:", e); alert(`Êó†Ê≥ïÊí≠ÊîæÈü≥‰πê„ÄÇ\nÈîôËØØ: ${e.message}`); });
                } else { console.log("Â∞ùËØïÊöÇÂÅú:", backgroundAudio.src); backgroundAudio.pause(); }
            });
            volumeControl.addEventListener('input', function() { backgroundAudio.volume = this.value; });
            customMusicUpload.addEventListener('change', function(event) {
                const file = event.target.files[0]; console.log("Ëá™ÂÆö‰πâÈü≥‰πêÊñá‰ª∂ÈÄâÊã©:", file);
                if (file && file.type.startsWith('audio/')) {
                    const objectURL = URL.createObjectURL(file); console.log("Ëá™ÂÆö‰πâÈü≥‰πê Object URL:", objectURL);
                    backgroundAudio.src = objectURL; backgroundAudio.load();
                    backgroundAudio.play().catch(e => { console.error("Êí≠ÊîæËá™ÂÆö‰πâÈü≥‰πêÂ§±Ë¥•:", e); alert("Êó†Ê≥ïÊí≠ÊîæËá™ÂÆö‰πâÈü≥‰πê„ÄÇÈîôËØØ: " + e.message); });
                    musicSelector.value = ""; playPauseMusicBtn.textContent = 'ÊöÇÂÅúÈü≥‰πê'; 
                } else if (file) { alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÊúâÊïàÁöÑÈü≥È¢ëÊñá‰ª∂ (‰æãÂ¶Ç MP3, WAV, OGG)„ÄÇ"); }
            });
            backgroundAudio.addEventListener('play', () => { playPauseMusicBtn.textContent = 'ÊöÇÂÅúÈü≥‰πê'; });
            backgroundAudio.addEventListener('pause', () => { playPauseMusicBtn.textContent = 'Êí≠ÊîæÈü≥‰πê'; });
            backgroundAudio.addEventListener('error', (e) => {
                console.error("Èü≥È¢ëÈîôËØØ‰∫ã‰ª∂:", backgroundAudio.error, e);
                alert(`Âä†ËΩΩÊàñÊí≠ÊîæÈü≥‰πêÊó∂ÂèëÁîüÈîôËØØ: ${backgroundAudio.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
            });
            
            // Initialize
            populateMusicSelector(); 
            const initialLayoutConfig = layoutButtonConfigs.find(c => c.className === currentLayoutClass) || layoutButtonConfigs[2]; 
            currentPhotosPerPage = initialLayoutConfig.photosPerPage;
            photoWall.classList.add(initialLayoutConfig.className);
            photoWall.style.position = 'relative'; photoWall.style.zIndex = '1'; photoWall.style.minHeight = '0';
            applyBackground('gradient1');
            backgroundAudio.volume = volumeControl.value; 
            renderCurrentPagePhotos(); 
            
            console.log('ÊÉÖ‰æ£ÁÖßÁâáÂ¢ôÂ∫îÁî®Â∑≤Ê∑ªÂä†ÁÖßÁâá‰ø°ÊÅØÁºñËæëÂäüËÉΩ„ÄÇ');
        });
    </script>
</body>
</html>