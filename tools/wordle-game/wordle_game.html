<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词拼图游戏</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 600px; /* 增加最大宽度 */
            box-sizing: border-box;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px; /* 调整间距 */
        }

        .first-letter-hint {
            font-size: 1.5em;
            font-weight: bold;
            color: #555;
            margin-bottom: 20px;
            height: 1.5em; /* 确保高度，避免布局跳动 */
        }

        .hint-display {
            font-size: 1.2em;
            color: #007bff;
            margin-bottom: 10px;
            min-height: 1.2em; /* 确保高度 */
        }

        .game-grid {
            display: flex;
            flex-direction: column; /* 保持垂直排列行 */
            gap: 5px;
            margin-bottom: 20px;
            align-items: center;
        }

        .row {
            display: flex;
            gap: 5px;
            justify-content: center;
            width: 100%; /* 确保行占据可用宽度 */
            max-width: calc(var(--word-length, 5) * 60px + (var(--word-length, 5) - 1) * 5px); /* 根据单词长度计算最大宽度 */
        }

        .tile {
            flex-basis: calc((100% - (var(--word-length, 5) - 1) * 5px) / var(--word-length, 5)); /* 动态计算宽度 */
            max-width: 60px; /* 最大宽度 */
            height: 60px;
            border: 2px solid #d3d6da;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: bold;
            text-transform: uppercase;
            color: #333;
            transition: all 0.3s ease-in-out;
            box-sizing: border-box;
        }

        /* 字母状态颜色 */
        .tile.correct {
            background-color: #6aaa64; /* 绿色 */
            color: white;
            border-color: #6aaa64;
        }

        .tile.present {
            background-color: #c9b458; /* 黄色 */
            color: white;
            border-color: #c9b458;
        }

        .tile.absent {
            background-color: #787c7e; /* 灰色 */
            color: white;
            border-color: #787c7e;
        }

        .keyboard {
            display: flex; /* 改为flex布局 */
            flex-direction: column; /* 垂直排列行 */
            gap: 6px; /* 行间距 */
            margin-top: 20px;
            width: 100%;
            max-width: 500px; /* 限制最大宽度 */
            align-items: center; /* 居中对齐 */
            margin-left: auto; /* 左右外边距自动，实现水平居中 */
            margin-right: auto;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 6px;
            width: 100%; /* 确保行占据可用宽度 */
        }

        .key {
            background-color: #d3d6da;
            border: none;
            border-radius: 5px;
            padding: 10px 5px; /* 调整padding，适应中文 */
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-grow: 1; /* 让按键在行内自适应宽度 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 30px; /* 确保按键有最小宽度，适应中文 */
            height: 50px;
        }

        .key.large {
            flex-grow: 1.5; /* 调整特殊按键的宽度 */
            font-size: 0.8em; /* 调整字体大小 */
            padding: 10px 2px; /* 调整padding */
        }

        .key:hover {
            background-color: #c0c3c7;
        }

        /* 键盘字母状态颜色 */
        .key.correct {
            background-color: #6aaa64;
            color: white;
        }

        .key.present {
            background-color: #c9b458;
            color: white;
        }

        .key.absent {
            background-color: #787c7e;
            color: white;
        }

        button#new-game-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.2s;
        }

        button#new-game-btn:hover {
            background-color: #0056b3;
        }

        .control-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.2s;
            white-space: nowrap; /* 防止按钮文本换行 */
        }

        .control-btn:hover {
            background-color: #5a6268;
        }

        /* 模态框样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* 默认隐藏，不占据空间 */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden; /* 默认隐藏 */
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
            display: flex; /* 显示时设置为flex */
        }

        .modal {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px; /* 增加模态框最大宽度 */
            text-align: left;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            display: none; /* 默认隐藏，不占据空间 */
        }

        .modal.visible { /* 只有当模态框自身有visible类时才显示 */
            transform: translateY(0);
            display: block; /* 显示时设置为block或flex */
        }

        .modal h2 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .modal .close-btn:hover {
            color: #333;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .setting-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setting-item label {
            font-weight: bold;
            color: #555;
        }

        .setting-item select,
        .setting-item input[type="checkbox"] {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
        }

        #guess-distribution {
            margin-top: 20px;
        }

        .guess-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .guess-label {
            width: 30px;
            text-align: right;
            margin-right: 10px;
            font-weight: bold;
        }

        .guess-bar {
            flex-grow: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .guess-fill {
            height: 100%;
            background-color: #6aaa64; /* 绿色 */
            width: 0%;
            transition: width 0.5s ease-out;
        }

        .tile-example {
            display: inline-flex;
            width: 30px;
            height: 30px;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            border-radius: 3px;
            margin-right: 5px;
        }

        /* 高对比度模式 */
        body.high-contrast .tile.correct {
            background-color: #f5793a; /* 橙色 */
            border-color: #f5793a;
        }

        body.high-contrast .tile.present {
            background-color: #85c0f9; /* 蓝色 */
            border-color: #85c0f9;
        }

        body.high-contrast .key.correct {
            background-color: #f5793a;
        }

        body.high-contrast .key.present {
            background-color: #85c0f9;
        }

        /* 字母翻转动画 */
        .tile.flip-in {
            animation: flip-in 0.3s forwards;
        }

        .tile.flip-out {
            animation: flip-out 0.3s forwards;
        }

        @keyframes flip-in {
            0% {
                transform: rotateX(90deg);
            }
            100% {
                transform: rotateX(0deg);
            }
        }

        @keyframes flip-out {
            0% {
                transform: rotateX(0deg);
            }
            100% {
                transform: rotateX(-90deg);
            }
        }


        /* 响应式设计 */
        @media (max-width: 600px) {
            .tile {
                flex-basis: calc((100% - (var(--word-length, 5) - 1) * 5px) / var(--word-length, 5));
                max-width: 50px;
                height: 50px;
                font-size: 1.8em;
            }

            .key {
                padding: 8px 10px;
                font-size: 1em;
                min-width: 30px;
                height: 45px;
            }

            .key.large {
                font-size: 0.7em; /* 调整字体大小 */
                padding: 8px 1px; /* 调整padding */
            }

            .container {
                padding: 15px;
            }

            .keyboard {
                max-width: 400px; /* 调整键盘最大宽度 */
            }
        }

        @media (max-width: 400px) {
            .tile {
                flex-basis: calc((100% - (var(--word-length, 5) - 1) * 5px) / var(--word-length, 5));
                max-width: 45px;
                height: 45px;
                font-size: 1.6em;
            }

            .key {
                padding: 6px 8px;
                font-size: 0.9em;
                min-width: 25px;
                height: 40px;
            }

            .key.large {
                font-size: 0.6em; /* 调整字体大小 */
                padding: 6px 1px; /* 调整padding */
            }

            .keyboard {
                max-width: 300px; /* 调整键盘最大宽度 */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>单词拼图游戏</h1>
        <div id="first-letter-hint" class="first-letter-hint"></div>
        <div id="hint-display" class="hint-display"></div> <!-- 新增提示显示区域 -->
        <div id="game-grid" class="game-grid"></div>
        <div id="keyboard" class="keyboard"></div>
        <button id="new-game-btn">新游戏</button>

        <!-- 设置按钮 -->
        <button id="settings-btn" class="control-btn">设置</button>
        <!-- 统计按钮 -->
        <button id="stats-btn" class="control-btn">统计</button>
        <!-- 规则按钮 -->
        <button id="rules-btn" class="control-btn">规则</button>
        <!-- 提示按钮 -->
        <button id="hint-btn" class="control-btn">提示</button>

    </div>

    <!-- 模态框容器 -->
    <div id="modal-overlay" class="modal-overlay">
        <!-- 设置模态框 -->
        <div id="settings-modal" class="modal">
            <h2>游戏设置</h2>
            <div class="setting-item">
                <label for="language-select">语言模式:</label>
                <select id="language-select">
                    <option value="en">英文</option>
                    <option value="zh">中文成语</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="word-length-select">单词长度 (英文):</label>
                <select id="word-length-select">
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="high-contrast-toggle">高对比度模式:</label>
                <input type="checkbox" id="high-contrast-toggle">
            </div>
            <button class="close-btn">关闭</button>
        </div>

        <!-- 统计模态框 -->
        <div id="stats-modal" class="modal">
            <h2>游戏统计</h2>
            <p>玩过次数: <span id="games-played">0</span></p>
            <p>胜场次数: <span id="games-won">0</span></p>
            <p>胜率: <span id="win-rate">0%</span></p>
            <h3>猜测分布</h3>
            <div id="guess-distribution"></div>
            <button class="close-btn">关闭</button>
        </div>

        <!-- 规则模态框 -->
        <div id="rules-modal" class="modal">
            <h2>游戏规则</h2>
            <p>猜单词，每次猜测后，方块的颜色会提示你离正确答案有多近。</p>
            <ul>
                <li><span class="tile-example correct">A</span> 绿色表示字母正确且位置正确。</li>
                <li><span class="tile-example present">B</span> 黄色表示字母正确但位置错误。</li>
                <li><span class="tile-example absent">C</span> 灰色表示单词中不包含该字母。</li>
            </ul>
            <p>你有6次机会猜出单词。</p>
            <button class="close-btn">关闭</button>
        </div>

        <!-- 胜利/失败弹窗 -->
        <div id="result-modal" class="modal">
            <h2 id="result-message"></h2>
            <p id="correct-word"></p>
            <button id="share-btn">分享结果</button>
            <button class="close-btn">关闭</button>
        </div>
    </div>

    <script>
        // 单词库
        const wordLists = {
            'en-4': ['acid', 'bake', 'calf', 'dark', 'earn', 'face', 'gain', 'halt', 'idle', 'joke', 'kite', 'lava', 'maze', 'navy', 'opal', 'pace', 'quiz', 'race', 'safe', 'tale', 'unit', 'vast', 'wake', 'xray', 'yawn', 'zero'],
            'en-5': ['apple', 'baker', 'candy', 'dream', 'eagle', 'flame', 'grape', 'house', 'igloo', 'jolly', 'knife', 'lemon', 'mango', 'night', 'ocean', 'piano', 'queen', 'river', 'snake', 'table', 'umbra', 'vivid', 'whale', 'xerox', 'yacht', 'zebra', 'gross'],
            'en-6': ['abacus', 'banana', 'cactus', 'danger', 'editor', 'fabric', 'garden', 'hazard', 'island', 'jungle', 'kettle', 'ladder', 'magnet', 'needle', 'orange', 'pencil', 'quiver', 'rabbit', 'saddle', 'tablet', 'unison', 'vortex', 'window', 'xylene', 'yellow', 'zodiac'],
            'en-7': ['abandon', 'balance', 'capture', 'develop', 'elegant', 'fantasy', 'gravity', 'harmony', 'imagine', 'journey', 'kingdom', 'lantern', 'mystery', 'natural', 'operate', 'perfect', 'quality', 'rainbow', 'science', 'thunder', 'uniform', 'venture', 'whisper', 'xylitol', 'younger', 'zealous'],
            'zh-chengyu': ['画蛇添足', '守株待兔', '亡羊补牢', '刻舟求剑', '掩耳盗铃', '拔苗助长', '对牛弹琴', '狐假虎威', '井底之蛙', '滥竽充数', '买椟还珠', '南辕北辙', '杞人忧天', '塞翁失马', '愚公移山', '自相矛盾', '叶公好龙', '朝三暮四', '杯弓蛇影', '东施效颦']
        };

        // 游戏配置
        let gameConfig = {
            language: 'en', // 'en' or 'zh'
            wordLength: 5, // 4, 5, 6, 7 (for English)
            theme: 'general', // 'general', 'animals', 'countries' (TODO: 实现主题选择)
            maxAttempts: 6,
            currentAttempt: 0,
            currentGuess: [],
            targetWord: '',
            gameEnded: false,
            highContrastMode: false,
            hintUsed: false // 新增提示使用标志
        };

        // 游戏统计数据
        let gameStats = {
            played: 0,
            won: 0,
            guessDistribution: {
                1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0
            },
            currentStreak: 0,
            maxStreak: 0,
            guessedWords: [] // 新增已猜过的单词记录
        };

        // DOM 元素
        const gameGrid = document.getElementById('game-grid');
        const keyboard = document.getElementById('keyboard');
        const newGameBtn = document.getElementById('new-game-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const statsBtn = document.getElementById('stats-btn');
        const rulesBtn = document.getElementById('rules-btn');
        const hintBtn = document.getElementById('hint-btn'); // 新增提示按钮
        const modalOverlay = document.getElementById('modal-overlay');
        const settingsModal = document.getElementById('settings-modal');
        const statsModal = document.getElementById('stats-modal');
        const rulesModal = document.getElementById('rules-modal');
        const resultModal = document.getElementById('result-modal');
        const resultMessage = document.getElementById('result-message');
        const correctWordDisplay = document.getElementById('correct-word');
        const shareBtn = document.getElementById('share-btn');
        const firstLetterHint = document.getElementById('first-letter-hint'); // 新增首字母提示元素
        const hintDisplay = document.getElementById('hint-display'); // 新增提示显示元素

        const languageSelect = document.getElementById('language-select');
        const wordLengthSelect = document.getElementById('word-length-select');
        const highContrastToggle = document.getElementById('high-contrast-toggle');
        const gamesPlayedSpan = document.getElementById('games-played');
        const gamesWonSpan = document.getElementById('games-won');
        const winRateSpan = document.getElementById('win-rate');
        const guessDistributionDiv = document.getElementById('guess-distribution');

        // 单词定义 (简化版，实际可扩展)
        const wordDefinitions = {
            'APPLE': '一种常见的水果。',
            'BAKER': '制作面包和糕点的人。',
            'CANDY': '糖果。',
            'DREAM': '睡眠时在大脑中产生的图像、声音或感觉。',
            'EAGLE': '一种大型猛禽。',
            'FLAME': '燃烧时发出的光和热。',
            'GRAPE': '一种常见的水果，通常成串生长。',
            'HOUSE': '供人居住的建筑物。',
            'IGLOO': '用冰雪块建造的圆顶形房屋。',
            'JOLLY': '快乐的，愉快的。',
            'KNIFE': '用于切割的工具。',
            'LEMON': '一种酸味的水果。',
            'MANGO': '一种热带水果。',
            'NIGHT': '白天和早晨之间的黑暗时期。',
            'OCEAN': '地球上广阔的咸水体。',
            'PIANO': '一种大型键盘乐器。',
            'QUEEN': '女王，或扑克牌中的Q。',
            'RIVER': '自然流动的淡水体。',
            'SNAKE': '一种无腿爬行动物。',
            'TABLE': '有平坦顶部和腿的家具。',
            'UMBRA': '本影，完全阴影区域。',
            'VIVID': '生动的，鲜明的。',
            'WHALE': '一种大型海洋哺乳动物。',
            'XEROX': '复印机品牌，也指复印。',
            'YACHT': '游艇。',
            'ZEBRA': '斑马。',
            'GROSS': '总的，全部的；粗俗的。', // 添加gross的定义
            '画蛇添足': '比喻做了多余的事，反而不恰当。',
            '守株待兔': '比喻死守经验，不知变通。',
            '亡羊补牢': '比喻出了问题及时补救，可以避免更大的损失。',
            '刻舟求剑': '比喻拘泥成例，不知道变通。',
            '掩耳盗铃': '比喻自己欺骗自己。',
            '拔苗助长': '比喻违反事物发展的规律，急于求成，反而坏事。',
            '对牛弹琴': '比喻对不懂道理的人讲道理，白费力气。',
            '狐假虎威': '比喻依仗别人的势力欺压人。',
            '井底之蛙': '比喻见识短浅的人。',
            '滥竽充数': '比喻没有真才实学的人混在行家里面充数。',
            '买椟还珠': '比喻没有眼力，取舍不当。',
            '南辕北辙': '比喻行动和目的正好相反。',
            '杞人忧天': '比喻不必要的或缺乏根据的忧虑。',
            '塞翁失马': '比喻坏事可以引出好的结果，好事也可以引出坏的结果。',
            '愚公移山': '比喻坚持不懈地改造自然和克服困难。',
            '自相矛盾': '比喻言行前后抵触。',
            '叶公好龙': '比喻口头上说爱好某事物，实际上却并非真正爱好。',
            '朝三暮四': '比喻反复无常，也比喻玩弄手法欺骗人。',
            '杯弓蛇影': '比喻疑神疑鬼，自相惊扰。',
            '东施效颦': '比喻胡乱模仿，效果很坏。'
        };


        // 初始化游戏
        function initializeGame() {
            gameConfig.currentAttempt = 0;
            gameConfig.currentGuess = []; // 确保清空当前猜测
            gameConfig.gameEnded = false;
            gameConfig.hintUsed = false; // 重置提示使用标志
            hintBtn.disabled = false; // 启用提示按钮
            hintDisplay.textContent = ''; // 清空提示显示
            gameGrid.innerHTML = '';
            keyboard.innerHTML = '';
            resetKeyboardColors();
            loadGameConfig(); // 加载配置
            loadGameStats(); // 加载统计
            selectTargetWord();
            // 设置CSS变量，用于动态调整方块宽度
            document.documentElement.style.setProperty('--word-length', gameConfig.targetWord.length);
            createGrid();
            createKeyboard();
            updateGrid(); // 确保初始网格显示正确
            hideAllModals();
            updateFirstLetterHint(); // 更新首字母提示
        }

        // 加载游戏配置
        function loadGameConfig() {
            const savedConfig = JSON.parse(localStorage.getItem('wordleGameConfig')) || {};
            // 仅加载与游戏配置相关的设置，不包括当前猜测状态
            gameConfig.language = savedConfig.language || gameConfig.language;
            gameConfig.wordLength = savedConfig.wordLength || gameConfig.wordLength;
            gameConfig.highContrastMode = savedConfig.highContrastMode || gameConfig.highContrastMode;

            languageSelect.value = gameConfig.language;
            wordLengthSelect.value = gameConfig.wordLength;
            highContrastToggle.checked = gameConfig.highContrastMode;
            applyHighContrastMode(gameConfig.highContrastMode);

            // 根据语言模式禁用或启用单词长度选择
            wordLengthSelect.disabled = gameConfig.language === 'zh';
        }

        // 保存游戏配置
        function saveGameConfig() {
            localStorage.setItem('wordleGameConfig', JSON.stringify(gameConfig));
        }

        // 加载游戏统计
        function loadGameStats() {
            const savedStats = JSON.parse(localStorage.getItem('wordleGameStats')) || {};
            gameStats = { ...gameStats, ...savedStats };
            updateStatsDisplay();
        }

        // 保存游戏统计
        function saveGameStats() {
            localStorage.setItem('wordleGameStats', JSON.stringify(gameStats));
        }

        // 更新统计显示
        function updateStatsDisplay() {
            gamesPlayedSpan.textContent = gameStats.played;
            gamesWonSpan.textContent = gameStats.won;
            const winRate = gameStats.played === 0 ? 0 : ((gameStats.won / gameStats.played) * 100).toFixed(1);
            winRateSpan.textContent = `${winRate}%`;

            guessDistributionDiv.innerHTML = '';
            for (let i = 1; i <= gameConfig.maxAttempts; i++) {
                const count = gameStats.guessDistribution[i] || 0;
                const totalGuesses = Object.values(gameStats.guessDistribution).reduce((sum, val) => sum + val, 0);
                const percentage = totalGuesses === 0 ? 0 : (count / totalGuesses) * 100;

                const barContainer = document.createElement('div');
                barContainer.classList.add('guess-bar-container');
                barContainer.innerHTML = `
                    <div class="guess-label">${i}</div>
                    <div class="guess-bar">
                        <div class="guess-fill" style="width: ${percentage}%;"></div>
                    </div>
                    <div class="guess-count">${count}</div>
                `;
                guessDistributionDiv.appendChild(barContainer);
            }
        }

        // 选择目标单词
        function selectTargetWord() {
            let words;
            if (gameConfig.language === 'en') {
                words = wordLists[`en-${gameConfig.wordLength}`];
            } else {
                words = wordLists['zh-chengyu'];
            }

            // 过滤掉已猜过的单词
            const availableWords = words.filter(word => !gameStats.guessedWords.includes(word.toUpperCase()));

            if (availableWords.length === 0) {
                showMessage('所有单词都已猜完！即将重新开始所有单词。');
                gameStats.guessedWords = []; // 重置已猜单词
                saveGameStats();
                // 重新选择单词
                gameConfig.targetWord = words[Math.floor(Math.random() * words.length)].toUpperCase();
            } else {
                gameConfig.targetWord = availableWords[Math.floor(Math.random() * availableWords.length)].toUpperCase();
            }
            
            console.log('目标单词:', gameConfig.targetWord); // 方便调试
            updateFirstLetterHint(); // 更新首字母提示
        }

        // 创建游戏网格
        function createGrid() {
            gameGrid.style.gridTemplateColumns = `repeat(${gameConfig.targetWord.length}, 1fr)`;
            for (let i = 0; i < gameConfig.maxAttempts; i++) {
                const row = document.createElement('div');
                row.classList.add('row');
                for (let j = 0; j < gameConfig.targetWord.length; j++) {
                    const tile = document.createElement('div');
                    tile.classList.add('tile');
                    row.appendChild(tile);
                }
                gameGrid.appendChild(row);
            }
        }

        // 创建虚拟键盘
        function createKeyboard() {
            const keyboardLayout = [
                ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
                ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'],
                ['ENTER', 'Z', 'X', 'C', 'V', 'B', 'N', 'M', 'BACKSPACE']
            ];

            // 动态生成中文键盘布局 (4行10列，包含待猜成语的字)
            const targetChars = gameConfig.targetWord.split('');
            const allChineseChars = new Set();
            wordLists['zh-chengyu'].forEach(chengyu => {
                chengyu.split('').forEach(char => allChineseChars.add(char));
            });

            let keyboardChars = [...new Set(targetChars)]; // 确保目标字不重复

            // 从所有中文成语中获取除目标字以外的字
            let otherChineseChars = Array.from(allChineseChars).filter(char => !keyboardChars.includes(char));

            // 随机打乱其他字
            for (let i = otherChineseChars.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [otherChineseChars[i], otherChineseChars[j]] = [otherChineseChars[j], otherChineseChars[i]];
            }

            // 填充到40个按键中，优先使用目标字，然后是其他随机字
            for (let i = 0; keyboardChars.length < 40 && i < otherChineseChars.length; i++) {
                keyboardChars.push(otherChineseChars[i]);
            }
            
            // 如果仍然不足40个，从所有字中补充（可能重复，但确保数量）
            while (keyboardChars.length < 40) {
                keyboardChars.push(Array.from(allChineseChars)[Math.floor(Math.random() * allChineseChars.size)]);
            }

            // 随机打乱最终的键盘字
            for (let i = keyboardChars.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [keyboardChars[i], keyboardChars[j]] = [keyboardChars[j], keyboardChars[i]];
            }

            const chineseKeyboardLayout = [];
            const charsPerRow = 10;
            for (let i = 0; i < 4; i++) { // 4行
                chineseKeyboardLayout.push(keyboardChars.slice(i * charsPerRow, (i + 1) * charsPerRow));
            }
            // 添加ENTER和BACKSPACE
            chineseKeyboardLayout.push(['ENTER', 'BACKSPACE']);

            const currentKeyboardLayout = gameConfig.language === 'en' ? keyboardLayout : chineseKeyboardLayout;

            keyboard.innerHTML = ''; // 清空现有键盘
            currentKeyboardLayout.forEach(rowKeys => {
                const rowDiv = document.createElement('div');
                rowDiv.classList.add('keyboard-row');
                rowKeys.forEach(keyText => {
                    const keyButton = document.createElement('button');
                    keyButton.classList.add('key');
                    keyButton.textContent = keyText;
                    if (keyText === 'ENTER' || keyText === 'BACKSPACE') {
                        keyButton.classList.add('large');
                    }
                    keyButton.addEventListener('click', () => handleKeyPress(keyText));
                    rowDiv.appendChild(keyButton);
                });
                keyboard.appendChild(rowDiv);
            });
        }

        // 重置键盘颜色
        function resetKeyboardColors() {
            const keys = keyboard.querySelectorAll('.key');
            keys.forEach(key => {
                key.classList.remove('correct', 'present', 'absent');
            });
        }

        // 处理按键输入
        function handleKeyPress(key) {
            if (gameConfig.gameEnded) return;

            if (key === 'ENTER') {
                if (gameConfig.currentGuess.length === gameConfig.targetWord.length) {
                    checkGuess();
                } else {
                    showMessage('单词长度不足！');
                }
            } else if (key === 'BACKSPACE') {
                gameConfig.currentGuess.pop();
                updateGrid();
            } else if (gameConfig.currentGuess.length < gameConfig.targetWord.length) {
                gameConfig.currentGuess.push(key);
                updateGrid();
            }
        }

        // 更新网格显示
        function updateGrid() {
            const currentRow = gameGrid.children[gameConfig.currentAttempt];
            for (let i = 0; i < gameConfig.targetWord.length; i++) {
                const tile = currentRow.children[i];
                tile.textContent = gameConfig.currentGuess[i] || '';
            }
        }

        // 检查猜测
        function checkGuess() {
            const guessWord = gameConfig.currentGuess.join('');
            const targetWord = gameConfig.targetWord;
            const currentRowTiles = gameGrid.children[gameConfig.currentAttempt].children;

            const letterStatus = Array(targetWord.length).fill(''); // 'correct', 'present', 'absent'
            const targetLetters = targetWord.split('');
            const guessLetters = guessWord.split('');

            // 第一次遍历：找出正确位置的字母 (绿色)
            for (let i = 0; i < targetWord.length; i++) {
                if (guessLetters[i] === targetLetters[i]) {
                    letterStatus[i] = 'correct';
                    targetLetters[i] = null; // 标记已匹配
                    guessLetters[i] = null; // 标记已匹配
                }
            }

            // 第二次遍历：找出包含但位置不正确的字母 (黄色)
            for (let i = 0; i < targetWord.length; i++) {
                if (guessLetters[i] !== null) {
                    const targetIndex = targetLetters.indexOf(guessLetters[i]);
                    if (targetIndex !== -1) {
                        letterStatus[i] = 'present';
                        targetLetters[targetIndex] = null; // 标记已匹配
                    } else {
                        letterStatus[i] = 'absent'; // 不包含该字母 (灰色)
                    }
                }
            }

            // 更新网格和键盘颜色，并添加翻转动画
            for (let i = 0; i < targetWord.length; i++) {
                const tile = currentRowTiles[i];
                tile.textContent = gameConfig.currentGuess[i]; // 先设置文本
                // 添加翻转动画
                setTimeout(() => {
                    tile.classList.add('flip-in');
                    tile.classList.add(letterStatus[i]); // 动画结束后添加颜色
                    updateKeyboardColor(gameConfig.currentGuess[i], letterStatus[i]); // 恢复键盘颜色更新
                }, i * 100); // 错开动画时间
            }

            // 在动画结束后检查是否为有效单词
            setTimeout(() => {
                if (!isValidWord(guessWord)) {
                    showMessage('不是一个有效单词！');
                    // 不返回，继续游戏流程，只是给出提示
                }

                if (guessWord === targetWord) {
                    gameEnded(true);
                } else if (gameConfig.currentAttempt === gameConfig.maxAttempts - 1) {
                    gameEnded(false);
                } else {
                    gameConfig.currentAttempt++;
                    gameConfig.currentGuess = [];
                }
            }, targetWord.length * 100 + 300); // 等待动画完成
        }

        // 验证单词是否有效
        function isValidWord(word) {
            let words;
            if (gameConfig.language === 'en') {
                words = wordLists[`en-${gameConfig.wordLength}`];
                return words.includes(word.toLowerCase()); // 英文单词库是小写，输入也转小写
            } else {
                words = wordLists['zh-chengyu'];
                return words.includes(word); // 中文成语库是原样，输入也原样
            }
        }

        // 更新键盘颜色
        function updateKeyboardColor(key, status) {
            // 查找包含特定文本的按键
            const keyButton = Array.from(keyboard.querySelectorAll('.key')).find(btn => {
                // 对于中文，可能需要匹配成语中的单个字
                if (gameConfig.language === 'zh') {
                    return btn.textContent.includes(key);
                }
                return btn.textContent === key;
            });

            if (keyButton) {
                // 优先级：正确 > 存在 > 不存在
                // 如果当前按键已经是绿色，则不更新
                if (keyButton.classList.contains('correct')) {
                    return;
                }
                // 如果当前按键是黄色，且新状态不是绿色，则不更新
                if (keyButton.classList.contains('present') && status !== 'correct') {
                    return;
                }

                keyButton.classList.remove('correct', 'present', 'absent');
                keyButton.classList.add(status);
            }
        }

        // 游戏结束
        function gameEnded(isWin) {
            gameConfig.gameEnded = true;
            gameStats.played++;
            if (isWin) {
                gameStats.won++;
                gameStats.currentStreak++;
                if (gameStats.currentStreak > gameStats.maxStreak) {
                    gameStats.maxStreak = gameStats.currentStreak;
                }
                gameStats.guessDistribution[gameConfig.currentAttempt + 1]++; // 记录猜测次数
                gameStats.guessedWords.push(gameConfig.targetWord); // 记录已猜过的单词
                resultMessage.textContent = '恭喜你，猜对了！';
            } else {
                gameStats.currentStreak = 0;
                resultMessage.textContent = '游戏结束，很遗憾！';
            }
            correctWordDisplay.textContent = `正确答案是：${gameConfig.targetWord}。`;
            if (wordDefinitions[gameConfig.targetWord]) {
                correctWordDisplay.textContent += ` 定义：${wordDefinitions[gameConfig.targetWord]}`;
            }
            saveGameStats();
            updateStatsDisplay();
            hideAllModals(); // 在显示结果模态框之前隐藏所有其他模态框
            showModal(resultModal);

            // 移除自动开始新游戏的逻辑，改为用户点击关闭按钮
        }

        // 显示消息提示 (例如：单词长度不足，不是有效单词)
        function showMessage(msg) {
            // TODO: 实现更友好的消息提示，例如短暂的Toast通知
            alert(msg);
        }

        // 模态框控制
        function showModal(modalElement) {
            hideAllModals(); // 在显示新模态框之前隐藏所有其他模态框
            modalOverlay.classList.add('visible');
            modalElement.classList.add('visible'); // 只给当前模态框添加visible类
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('visible');
            modalOverlay.classList.remove('visible');
        }

        function hideAllModals() {
            // 确保移除所有模态框的 visible 类
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('visible');
            });
            modalOverlay.classList.remove('visible');
        }

        // 应用高对比度模式
        function applyHighContrastMode(enable) {
            if (enable) {
                document.body.classList.add('high-contrast');
            } else {
                document.body.classList.remove('high-contrast');
            }
        }

        // 更新首字母提示
        function updateFirstLetterHint() {
            if (gameConfig.language === 'en') {
                firstLetterHint.textContent = `首字母: ${gameConfig.targetWord.charAt(0)}`;
            } else {
                firstLetterHint.textContent = `首字: ${gameConfig.targetWord.charAt(0)}`;
            }
        }

        // 提示功能
        function provideHint() {
            if (gameConfig.gameEnded || gameConfig.hintUsed) {
                showMessage('每局游戏只能使用一次提示！');
                return;
            }

            const targetWord = gameConfig.targetWord;
            const currentGuessLetters = gameConfig.currentGuess;

            // 找到一个未猜对的字母位置
            let hintIndex = -1;
            const availableIndices = [];
            for (let i = 0; i < targetWord.length; i++) {
                // 只有当当前格子为空或不正确时才提供提示
                if (!currentGuessLetters[i] || currentGuessLetters[i] !== targetWord[i]) {
                    availableIndices.push(i);
                }
            }

            if (availableIndices.length > 0) {
                hintIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
                
                // 显示提示字母，不自动填入
                hintDisplay.textContent = `提示：第 ${hintIndex + 1} 个字母是 '${targetWord[hintIndex]}'`;
                gameConfig.hintUsed = true; // 设置提示已使用
                hintBtn.disabled = true; // 禁用提示按钮
            } else {
                showMessage('没有可用的提示了！');
            }
        }

        // 绑定事件
        newGameBtn.addEventListener('click', initializeGame);

        settingsBtn.addEventListener('click', () => showModal(settingsModal));
        statsBtn.addEventListener('click', () => showModal(statsModal));
        rulesBtn.addEventListener('click', () => showModal(rulesModal));
        hintBtn.addEventListener('click', provideHint); // 绑定提示按钮事件

        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay) {
                hideAllModals();
            }
        });

        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                hideAllModals();
                // 如果是结果模态框的关闭按钮，则开始新游戏
                if (btn.closest('#result-modal')) {
                    initializeGame();
                }
            });
        });

        languageSelect.addEventListener('change', (event) => {
            gameConfig.language = event.target.value;
            wordLengthSelect.disabled = gameConfig.language === 'zh';
            saveGameConfig();
            initializeGame();
        });

        wordLengthSelect.addEventListener('change', (event) => {
            gameConfig.wordLength = parseInt(event.target.value);
            saveGameConfig();
            initializeGame();
        });

        highContrastToggle.addEventListener('change', (event) => {
            gameConfig.highContrastMode = event.target.checked;
            applyHighContrastMode(gameConfig.highContrastMode);
            saveGameConfig();
        });

        shareBtn.addEventListener('click', () => {
            const shareText = `我刚刚在单词拼图游戏中猜出了单词 "${gameConfig.targetWord}"！\n我在第 ${gameConfig.currentAttempt + 1} 次尝试中成功。\n快来挑战吧！`;
            navigator.clipboard.writeText(shareText).then(() => {
                showMessage('结果已复制到剪贴板！');
            }).catch(err => {
                console.error('复制失败:', err);
                showMessage('复制失败，请手动复制。');
            });
        });


        document.addEventListener('keydown', (event) => {
            if (gameConfig.gameEnded && event.key !== 'Escape') return; // 游戏结束只允许Esc关闭模态框

            if (modalOverlay.classList.contains('visible') && event.key === 'Escape') {
                hideAllModals();
                return;
            }

            const key = event.key.toUpperCase();
            // 允许英文或中文输入
            const isEnglishLetter = key.length === 1 && key >= 'A' && key <= 'Z';
            const isChineseChar = gameConfig.language === 'zh' && key.length === 1 && wordLists['zh-chengyu'].some(word => word.includes(key)); // 简单判断是否为中文成语中的字

            if (isEnglishLetter || isChineseChar) {
                handleKeyPress(key);
            } else if (key === 'ENTER') {
                handleKeyPress('ENTER');
            } else if (key === 'BACKSPACE') {
                handleKeyPress('BACKSPACE');
            }
        });

        // 初始加载
        initializeGame();

        // 辅助函数：用于querySelector查找包含特定文本的元素
        // 注意：Element.prototype.contains 是非标准的，已替换为更健壮的查找方式
        // 移除旧的非标准辅助函数
    </script>
</body>
</html>