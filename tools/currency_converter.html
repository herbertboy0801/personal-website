<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´§å¸æ¢ç®—å·¥å…·</title>
    <!-- å¼•å…¥ Chart.js (å°è¯•æ›´æ¢ CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQd9O5fXXPCkvMq57QelYFJquztNutXcurrentNode/chartjs/dist/Chart.min.js" referrerpolicy="no-referrer"></script>
     <!-- ä¹Ÿå¯ä»¥è€ƒè™‘ä¸‹è½½æœ¬åœ°æ–‡ä»¶: <script src="path/to/chart.min.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px 30px 15px 30px; /* å‡å°‘åº•éƒ¨å†…è¾¹è·ï¼Œç»™æ—¶é—´æˆ³ç•™ç©ºé—´ */
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .converter-section {
            padding: 30px 30px 50px 30px; /* å¢åŠ åº•éƒ¨å†…è¾¹è· */
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .currency-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .amount-input {
            flex: 2;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .amount-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .currency-select {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .currency-select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .swap-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .swap-btn:hover {
            background: #45a049;
            transform: rotate(180deg);
        }

        .result-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .result-amount {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .exchange-rate {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .copy-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .copy-btn:hover {
            background: #1976D2;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-header h3 {
            color: #333;
            font-size: 18px;
        }

        .clear-history {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .clear-history:hover {
            background: #d32f2f;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-conversion {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .history-rate {
            color: #666;
            font-size: 12px;
        }

        .currency-symbol {
            font-weight: 700;
            color: #4CAF50;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .empty-history {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .converter-section {
                padding: 20px;
            }

            .currency-row {
                flex-direction: column;
                gap: 15px;
            }

            .amount-input,
            .currency-select {
                width: 100%;
            }

            .result-amount {
                font-size: 28px;
            }

            .toast {
                right: 10px;
                left: 10px;
                top: 10px;
            }
        }

        @media (max-width: 400px) {
            .header h1 {
                font-size: 20px;
            }

            .result-amount {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’± è´§å¸æ¢ç®—å·¥å…·</h1>
            <p>æ”¯æŒå¤šç§å¸¸ç”¨è´§å¸å®æ—¶æ¢ç®—</p>
            <!-- ç§»åŠ¨æ±‡ç‡æ›´æ–°æ—¶é—´åˆ°è¿™é‡Œ -->
            <div id="rates-timestamp" style="font-size: 12px; color: rgba(255, 255, 255, 0.8); text-align: center; padding-bottom: 15px; margin-top: 8px; /* æ·»åŠ é¡¶éƒ¨å¤–è¾¹è· */"></div>
        </div>

        <div class="converter-section">
             <!-- æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨ -->
             <div id="loading-indicator" style="display: none; text-align: center; padding: 10px 0 20px 0; font-size: 14px; color: #666;">æ­£åœ¨åŠ è½½æœ€æ–°æ±‡ç‡...</div>
            <div class="input-group">
                <label for="from-amount">ä»</label>
                <div class="currency-row">
                    <input type="number" id="from-amount" class="amount-input" placeholder="è¾“å…¥é‡‘é¢" min="0" step="0.01">
                    <select id="from-currency" class="currency-select">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>

            <button class="swap-btn" id="swap-btn" title="äº¤æ¢è´§å¸">â‡…</button>

            <div class="input-group">
                <label for="to-currency">åˆ°</label>
                <div class="currency-row">
<button id="convert-btn" style="display: block; width: 100%; padding: 15px; background-color: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 18px; cursor: pointer; margin-top: 25px; transition: background-color 0.3s ease;">ç«‹å³è½¬æ¢</button>
                    <div class="amount-input" style="background: #f8f9fa; color: #666;" id="result-display">è½¬æ¢ç»“æœ</div>
                    <select id="to-currency" class="currency-select">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>

            <div class="result-section" id="result-section" style="display: none;">
                <div class="result-amount" id="result-amount">0.00</div>
                <div class="exchange-rate" id="exchange-rate">æ±‡ç‡: 1 USD = 7.20 CNY</div>
                <button class="copy-btn" id="copy-btn" onclick="copyResult()">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
            </div>

<!-- å›¾è¡¨å®¹å™¨ -->
            <div class="chart-section" style="margin-top: 30px; margin-bottom: 50px; /* å¢åŠ åº•éƒ¨å¤–è¾¹è· */ height: 250px; position: relative; overflow: hidden;">
                 <h3 style="text-align: center; margin-bottom: 15px; color: #333; font-size: 18px;">
                     ğŸ“ˆ è¿‘7å¤©æ±‡ç‡è¶‹åŠ¿ (<span id="chart-currency-pair"></span>)
                 </h3>
                 <canvas id="historyChart" style="display: block; max-width: 100%; height: 100%; /* å¡«å……å®¹å™¨é«˜åº¦ */"></canvas>
                 <p id="chart-api-notice" style="font-size: 12px; color: #888; text-align: center; margin-top: 10px; display: none;">æ³¨æ„ï¼šå…è´¹APIä¸æ”¯æŒå†å²æ±‡ç‡æŸ¥è¯¢ï¼Œå›¾è¡¨æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ã€‚</p>
                 <!-- å›¾è¡¨åŠ è½½æŒ‡ç¤ºå™¨ -->
                 <div id="chart-loading-indicator" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; color: #666;">åŠ è½½å›¾è¡¨ä¸­...</div>
            </div>
            <div class="history-section">
                <div class="history-header">
                    <h3>ğŸ“ˆ æ¢ç®—è®°å½•</h3>
                    <button class="clear-history" onclick="clearHistory()">æ¸…ç©ºè®°å½•</button>
                </div>
                <div class="history-list" id="history-list">
                    <div class="empty-history">æš‚æ— æ¢ç®—è®°å½•</div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // è´§å¸é…ç½®
        const currencies = {
            CNY: { symbol: 'Â¥', name: 'äººæ°‘å¸' },
            USD: { symbol: '$', name: 'ç¾å…ƒ' },
            EUR: { symbol: 'â‚¬', name: 'æ¬§å…ƒ' },
            GBP: { symbol: 'Â£', name: 'è‹±é•‘' },
            JPY: { symbol: 'Â¥', name: 'æ—¥å…ƒ' }
        };

        // ç”¨äºå­˜å‚¨ä»APIè·å–çš„æ±‡ç‡
        let apiExchangeRates = {};
        let ratesLastUpdated = null;

        // æ¢ç®—å†å²è®°å½•
        let conversionHistory = JSON.parse(localStorage.getItem('conversionHistory')) || [];

        // API é…ç½® (ä½¿ç”¨ ExchangeRate-API V6)
        const API_URL = 'https://v6.exchangerate-api.com/v6/f567be40c53c8e54aa5f0279/latest/USD'; // è¯·æ›¿æ¢ YOUR_API_KEY
        // æ³¨æ„ï¼šä¸ºäº†å®‰å…¨ï¼ŒAPIå¯†é’¥ä¸åº”ç›´æ¥ç¡¬ç¼–ç åœ¨å‰ç«¯ä»£ç ä¸­ã€‚
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå»ºè®®é€šè¿‡åç«¯ä»£ç†æˆ–æœåŠ¡å™¨ç«¯å‡½æ•°æ¥å¤„ç†APIè¯·æ±‚ã€‚
        // è¿™é‡Œéœ€è¦æ‚¨æä¾›è‡ªå·±çš„APIå¯†é’¥ã€‚æ‚¨å¯ä»¥ä» https://www.exchangerate-api.com/ è·å–å…è´¹APIå¯†é’¥ã€‚
        const USER_API_KEY = 'f567be40c53c8e54aa5f0279'; // è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„æœ‰æ•ˆAPIå¯†é’¥
        const actualApiUrl = `https://v6.exchangerate-api.com/v6/${USER_API_KEY}/latest/USD`;

        // DOMå…ƒç´ 
        const fromAmountInput = document.getElementById('from-amount');
        const fromCurrencySelect = document.getElementById('from-currency');
        const toCurrencySelect = document.getElementById('to-currency');
        const swapBtn = document.getElementById('swap-btn');
        const resultSection = document.getElementById('result-section');
        const resultAmount = document.getElementById('result-amount');
        const exchangeRateDisplay = document.getElementById('exchange-rate');
        const historyList = document.getElementById('history-list');
        const toast = document.getElementById('toast');
        const resultDisplay = document.getElementById('result-display'); // Get the result display element
        const historyChartCanvas = document.getElementById('historyChart');
        const chartCurrencyPairSpan = document.getElementById('chart-currency-pair');
        const chartApiNotice = document.getElementById('chart-api-notice');
        const convertBtn = document.getElementById('convert-btn'); // Get the new button
        let historyChart = null; // ç”¨äºå­˜å‚¨ Chart.js å®ä¾‹

         // åˆå§‹åŒ–åº”ç”¨
         async function initApp() {
            showLoadingState(true);
            await fetchExchangeRates();
            showLoadingState(false);
            loadHistory();
            attachEventListeners();
            // ä¸å†éœ€è¦åœ¨åˆå§‹åŒ–æ—¶ç»˜åˆ¶å›¾è¡¨
            // setTimeout(updateChart, 50);
            // åˆå§‹éšè—ç»“æœåŒºå’Œå›¾è¡¨åŒº
            hideResult();
            if (historyChartCanvas) historyChartCanvas.style.display = 'none';
            const chartSection = document.querySelector('.chart-section');
            if (chartSection) chartSection.style.display = 'none';
        }

        // ä»APIè·å–æ±‡ç‡
        async function fetchExchangeRates() {
            console.log('å¼€å§‹è·å–æ±‡ç‡...'); // Log start
            try {
                console.log(`æ­£åœ¨è¯·æ±‚ API: ${actualApiUrl}`); // Log URL
                const response = await fetch(actualApiUrl);
                console.log(`API å“åº”çŠ¶æ€: ${response.status}`); // Log status
                if (!response.ok) {
                     const errorText = await response.text(); // Try to get error text
                     console.error(`API å“åº”é”™è¯¯æ–‡æœ¬: ${errorText}`);
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                const data = await response.json();

                if (data.result === 'success') {
                    apiExchangeRates = data.conversion_rates;
                    ratesLastUpdated = new Date(data.time_last_update_unix * 1000);
                    console.log('æ±‡ç‡è·å–æˆåŠŸ:', apiExchangeRates);
                    populateCurrencyOptions(apiExchangeRates); // å¡«å……è´§å¸é€‰é¡¹
                    updateRatesTimestamp(); // æ›´æ–°ç•Œé¢ä¸Šçš„æ—¶é—´æˆ³
                } else {
                    console.error('APIè¿”å›é”™è¯¯:', data['error-type']);
                    showToast(`è·å–æ±‡ç‡å¤±è´¥: ${data['error-type']}`, 'error');
                    // ä½œä¸ºå¤‡é€‰ï¼Œå¯ä»¥åŠ è½½ä¸€ç»„é»˜è®¤/ä¸Šæ¬¡ç¼“å­˜çš„æ±‡ç‡
                    apiExchangeRates = {}; // Ensure rates object is empty on failure
                }
            } catch (error) {
                console.error('è·å–æ±‡ç‡æ—¶æ•è·åˆ°é”™è¯¯:', error); // Enhanced log
                showToast(`è·å–æ±‡ç‡å‡ºé”™: ${error.message}`, 'error');
                 apiExchangeRates = {}; // Ensure rates object is empty on error
                // å¤„ç†ç½‘ç»œé”™è¯¯ç­‰
            } finally {
                 console.log('è·å–æ±‡ç‡æµç¨‹ç»“æŸ.'); // Log end
            }
        }

        // æ›´æ–°æ±‡ç‡æ›´æ–°æ—¶é—´æ˜¾ç¤º (ç°åœ¨æ”¾åœ¨ header é‡Œ)
        function updateRatesTimestamp() {
            const timestampElement = document.getElementById('rates-timestamp');
            if (timestampElement && ratesLastUpdated) {
                 timestampElement.textContent = `æ±‡ç‡æ›´æ–°äº: ${ratesLastUpdated.toLocaleString('zh-CN', { dateStyle: 'short', timeStyle: 'short' })}`;
                 timestampElement.style.display = 'block';
            } else if (timestampElement) {
                timestampElement.style.display = 'none'; // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³åˆ™éšè—
            }
        }

         // å¡«å……è´§å¸ä¸‹æ‹‰é€‰é¡¹
         function populateCurrencyOptions(rates) {
             if (!rates || Object.keys(rates).length === 0) {
                  console.error("æ— æ³•å¡«å……è´§å¸é€‰é¡¹ï¼Œæ±‡ç‡æ•°æ®æ— æ•ˆã€‚");
                  showToast('æ— æ³•åŠ è½½è´§å¸åˆ—è¡¨ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'error'); // æ·»åŠ ç”¨æˆ·æç¤º
                  // å³ä½¿å¤±è´¥ï¼Œä¹Ÿå°è¯•å¡«å……é¢„å®šä¹‰è´§å¸ä½œä¸ºå¤‡é€‰
                  const fallbackCurrencies = Object.keys(currencies);
                  if (fallbackCurrencies.length > 0) {
                     console.warn("æ­£åœ¨ä½¿ç”¨é¢„å®šä¹‰è´§å¸åˆ—è¡¨ä½œä¸ºå¤‡é€‰ã€‚");
                     fallbackCurrencies.forEach(code => addOption(code));
                     setDefaults(fallbackCurrencies);
                  }
                  return;
             }
             // æ¸…ç©ºç°æœ‰é€‰é¡¹
             fromCurrencySelect.innerHTML = '';
             toCurrencySelect.innerHTML = '';

             // è·å–æ‰€æœ‰æ”¯æŒçš„è´§å¸ä»£ç  (æ¥è‡ª API å“åº”) å¹¶æ’åº
             const supportedCurrencies = Object.keys(rates).sort();

             // æ·»åŠ æ¯ä¸ªè´§å¸åˆ°ä¸‹æ‹‰åˆ—è¡¨
             supportedCurrencies.forEach(currencyCode => {
                 addOption(currencyCode);
             });

             // è®¾ç½®é»˜è®¤é€‰é¡¹
             setDefaults(supportedCurrencies);

              // åˆå§‹è§¦å‘ä¸€æ¬¡è½¬æ¢ï¼ˆå¦‚æœé‡‘é¢å·²è¾“å…¥ï¼‰
             if (fromAmountInput.value) {
                 handleConversion();
             }
         }

         // Helper function to add an option to both selects
         function addOption(currencyCode) {
             const currencyInfo = currencies[currencyCode]; // Check our predefined list
             const optionText = currencyInfo
                 ? `${currencyInfo.symbol} ${currencyInfo.name || currencyCode}` // Use symbol and name if available
                 : currencyCode; // Fallback to just the code

             const optionFrom = document.createElement('option');
             optionFrom.value = currencyCode;
             optionFrom.textContent = optionText;
             fromCurrencySelect.appendChild(optionFrom);

             const optionTo = document.createElement('option');
             optionTo.value = currencyCode;
             optionTo.textContent = optionText;
             toCurrencySelect.appendChild(optionTo);
         }

         // Helper function to set default selected currencies
         function setDefaults(availableCurrencies) {
             const defaultFrom = 'CNY';
             const defaultTo = 'USD';

             if (availableCurrencies.includes(defaultFrom)) {
                 fromCurrencySelect.value = defaultFrom;
             } else if (availableCurrencies.length > 0) {
                 fromCurrencySelect.value = availableCurrencies[0]; // Fallback to first available
             }

             if (availableCurrencies.includes(defaultTo)) {
                 toCurrencySelect.value = defaultTo;
             } else if (availableCurrencies.length > 1) {
                 // Try to pick a different default 'to' currency
                 toCurrencySelect.value = availableCurrencies.find(c => c !== fromCurrencySelect.value) || availableCurrencies[0];
             } else if (availableCurrencies.length > 0) {
                  toCurrencySelect.value = availableCurrencies[0];
             }
         }


        // æ˜¾ç¤º/éšè—ä¸»åŠ è½½çŠ¶æ€
        function showLoadingState(isLoading) {
           const loadingElement = document.getElementById('loading-indicator');
           if (loadingElement) {
               loadingElement.style.display = isLoading ? 'block' : 'none';
           }
           // å¯ä»¥åœ¨åŠ è½½æ—¶ç¦ç”¨è¾“å…¥
            fromAmountInput.disabled = isLoading;
            fromCurrencySelect.disabled = isLoading;
            toCurrencySelect.disabled = isLoading;
            swapBtn.disabled = isLoading;
            // åŒæ—¶éšè—/æ˜¾ç¤ºè½¬æ¢ç»“æœåŒºå’Œå›¾è¡¨åŒº
            resultSection.style.display = isLoading ? 'none' : (fromAmountInput.value && parseFloat(fromAmountInput.value) > 0 ? 'block' : 'none');
            const chartSection = document.querySelector('.chart-section');
            if (chartSection) {
                 chartSection.style.display = isLoading ? 'none' : 'block';
            }

       }


        // é˜²æŠ–å‡½æ•°
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function attachEventListeners() {
            // è¾“å…¥å’Œé€‰æ‹©æ›´æ”¹ä¸å†è‡ªåŠ¨è§¦å‘
            // fromAmountInput.addEventListener('input', debounce(handleConversion, 300)); // Removed
            // fromCurrencySelect.addEventListener('change', () => { /* handleConversion(); updateChart(); */ }); // Removed
            // toCurrencySelect.addEventListener('change', () => { /* handleConversion(); updateChart(); */ }); // Removed

            // äº¤æ¢æŒ‰é’®åªäº¤æ¢è´§å¸
            swapBtn.addEventListener('click', swapCurrencies); // Removed updateChart call

            // ä¸ºæ–°çš„è½¬æ¢æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            convertBtn.addEventListener('click', () => {
                handleConversion(); // æ‰§è¡Œè½¬æ¢ã€æ˜¾ç¤ºç»“æœã€ä¿å­˜å†å²
                updateChart();    // æ›´æ–°å›¾è¡¨
            });

            // æ”¯æŒåœ¨é‡‘é¢è¾“å…¥æ¡†æŒ‰å›è½¦é”®è§¦å‘è½¬æ¢æŒ‰é’®
            fromAmountInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // é˜»æ­¢å¯èƒ½çš„è¡¨å•æäº¤
                    convertBtn.click(); // è§¦å‘è½¬æ¢æŒ‰é’®ç‚¹å‡»
                }
            });
        }

        // å¤„ç†è´§å¸è½¬æ¢
        function handleConversion() {
            const amount = parseFloat(fromAmountInput.value);
            const fromCurrency = fromCurrencySelect.value;
            const toCurrency = toCurrencySelect.value;

            if (!amount || amount <= 0) {
                hideResult();
                return;
            }

            // ç¡®ä¿æ±‡ç‡å·²åŠ è½½
            if (Object.keys(apiExchangeRates).length === 0) {
                showToast('æ±‡ç‡æ•°æ®å°šæœªåŠ è½½ï¼Œè¯·ç¨å€™...', 'warning');
                return;
            }

            const convertedAmount = convertCurrency(amount, fromCurrency, toCurrency);
            const rate = getExchangeRate(fromCurrency, toCurrency);

            // æ›´æ–°é¡¶éƒ¨ç»“æœæ˜¾ç¤º (ç¡®ä¿ currencies[toCurrency] å­˜åœ¨æˆ–æœ‰å›é€€)
            const toSymbol = currencies[toCurrency] ? currencies[toCurrency].symbol : '';
            resultDisplay.innerHTML = `<span class="currency-symbol">${toSymbol}</span> ${formatNumber(convertedAmount)}`;

            displayResult(convertedAmount, fromCurrency, toCurrency, amount, rate);
            saveToHistory(amount, fromCurrency, convertedAmount, toCurrency, rate);
        }

        // è´§å¸è½¬æ¢æ ¸å¿ƒé€»è¾‘
        function convertCurrency(amount, fromCurrency, toCurrency) {
            // ä½¿ç”¨ä»APIè·å–çš„æ±‡ç‡ (ä»¥USDä¸ºåŸºå‡†)
            const fromRate = apiExchangeRates[fromCurrency];
            const toRate = apiExchangeRates[toCurrency];

            if (fromRate === undefined || toRate === undefined) {
                 console.error(`æ— æ³•æ‰¾åˆ°è´§å¸ ${fromCurrency} æˆ– ${toCurrency} çš„æ±‡ç‡`);
                 showToast(`ç¼ºå°‘æ±‡ç‡: ${fromCurrency} æˆ– ${toCurrency}`, 'error');
                 return 0; // æˆ–è€…è¿”å› null/undefined å¹¶å¤„ç†
            }

            // å› ä¸ºæ‰€æœ‰æ±‡ç‡éƒ½æ˜¯ç›¸å¯¹äºUSDçš„ï¼Œæ‰€ä»¥è½¬æ¢å¾ˆç®€å•
            const usdAmount = amount / fromRate;
            const convertedAmount = usdAmount * toRate;

            return convertedAmount;
        }

        // è·å–æ±‡ç‡
        function getExchangeRate(fromCurrency, toCurrency) {
             // ä½¿ç”¨ä»APIè·å–çš„æ±‡ç‡ (ä»¥USDä¸ºåŸºå‡†)
            const fromRate = apiExchangeRates[fromCurrency];
            const toRate = apiExchangeRates[toCurrency];

            if (fromRate === undefined || toRate === undefined) {
                 return 0; // æˆ–è€…è¿”å› null/undefined
            }

            // è®¡ç®—ä» fromCurrency åˆ° toCurrency çš„ç›´æ¥æ±‡ç‡
            return toRate / fromRate;
        }

        // æ˜¾ç¤ºè½¬æ¢ç»“æœ
        function displayResult(convertedAmount, fromCurrency, toCurrency, originalAmount, rate) {
            // å®‰å…¨åœ°è·å–ç¬¦å·ï¼Œå¦‚æœæœªåœ¨ currencies ä¸­å®šä¹‰ï¼Œåˆ™ä¸æ˜¾ç¤ºç¬¦å·
            const fromSymbol = currencies[fromCurrency] ? currencies[fromCurrency].symbol : '';
            const toSymbol = currencies[toCurrency] ? currencies[toCurrency].symbol : '';

            resultAmount.innerHTML = `<span class="currency-symbol">${toSymbol}</span> ${formatNumber(convertedAmount)}`;
            exchangeRateDisplay.textContent = `æ±‡ç‡: 1 ${fromCurrency} = ${formatNumber(rate)} ${toCurrency}`;

            resultSection.style.display = 'block';
        }

        // éšè—ç»“æœ
        function hideResult() {
            resultSection.style.display = 'none';
        }

        // äº¤æ¢è´§å¸ (åªäº¤æ¢å€¼)
        function swapCurrencies() {
            const fromCurrency = fromCurrencySelect.value;
            const toCurrency = toCurrencySelect.value;
            
            fromCurrencySelect.value = toCurrency;
            toCurrencySelect.value = fromCurrency;
            
            // ä¸å†è‡ªåŠ¨è§¦å‘è½¬æ¢
            // if (fromAmountInput.value) {
            //     handleConversion();
            // }
        }

        // å¤åˆ¶ç»“æœ
        function copyResult() {
            const amount = fromAmountInput.value;
            const fromCurrency = fromCurrencySelect.value;
            const toCurrency = toCurrencySelect.value;
            const convertedAmount = convertCurrency(parseFloat(amount), fromCurrency, toCurrency);
            
            // å®‰å…¨åœ°è·å–ç¬¦å·
            const fromSymbol = currencies[fromCurrency] ? currencies[fromCurrency].symbol : '';
            const toSymbol = currencies[toCurrency] ? currencies[toCurrency].symbol : '';

            const copyText = `${fromSymbol}${amount} ${fromCurrency} = ${toSymbol}${formatNumber(convertedAmount)} ${toCurrency}`;

            if (!amount || !convertedAmount || isNaN(convertedAmount)) { // å¢åŠ  NaN æ£€æŸ¥
                 showToast('æ²¡æœ‰æœ‰æ•ˆçš„å¯å¤åˆ¶ç»“æœ', 'warning');
                 return;
            }

            navigator.clipboard.writeText(copyText).then(() => {
                showToast('ç»“æœå·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼', 'success');
            }).catch((err) => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™æˆ–æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(fromAmount, fromCurrency, toAmount, toCurrency, rate) {
            const historyItem = {
                id: Date.now(),
                fromAmount: fromAmount,
                fromCurrency: fromCurrency,
                toAmount: toAmount,
                toCurrency: toCurrency,
                rate: rate,
                timestamp: new Date().toLocaleString('zh-CN')
            };

            conversionHistory.unshift(historyItem);
            
            // åªä¿ç•™æœ€è¿‘5æ¡è®°å½•
            if (conversionHistory.length > 5) {
                conversionHistory = conversionHistory.slice(0, 5);
            }
            
            localStorage.setItem('conversionHistory', JSON.stringify(conversionHistory));
            renderHistory();
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            if (conversionHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-history">æš‚æ— æ¢ç®—è®°å½•</div>';
                return;
            }

            const historyHTML = conversionHistory.map(item => {
                // å®‰å…¨åœ°è·å–ç¬¦å·
                const fromSymbol = currencies[item.fromCurrency] ? currencies[item.fromCurrency].symbol : '';
                const toSymbol = currencies[item.toCurrency] ? currencies[item.toCurrency].symbol : '';

                return `
                    <div class="history-item">
                        <div class="history-conversion">
                            ${fromSymbol}${formatNumber(item.fromAmount)} ${item.fromCurrency}
                            â†’ ${toSymbol}${formatNumber(item.toAmount)} ${item.toCurrency}
                        </div>
                        <div class="history-rate">
                            æ±‡ç‡: ${formatNumber(item.rate)} | ${item.timestamp}
                        </div>
                    </div>
                `;
            }).join('');

            historyList.innerHTML = historyHTML;
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            renderHistory();
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¢ç®—è®°å½•å—ï¼Ÿ')) {
                conversionHistory = [];
                localStorage.removeItem('conversionHistory');
                renderHistory();
                showToast('å†å²è®°å½•å·²æ¸…ç©º');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') { // type: 'success', 'error', 'warning'
            toast.textContent = message;
            toast.className = 'toast'; // Reset classes
            toast.classList.add(`toast-${type}`); // Add type specific class for styling
            toast.classList.add('show');


            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
        function formatNumber(num) {
            if (num >= 1) {
                return num.toFixed(2);
            } else {
                return num.toFixed(4);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);


        // --- å›¾è¡¨ç›¸å…³å‡½æ•° ---

        // è·å–å†å²æ±‡ç‡ (æ³¨æ„ï¼šæ­¤åŠŸèƒ½éœ€è¦ä»˜è´¹API)
        async function fetchHistoricalRates(base, target, days = 7) {
            console.log(`å°è¯•è·å– ${base} åˆ° ${target} çš„ ${days} å¤©å†å²æ±‡ç‡...`);
            chartApiNotice.style.display = 'block'; // æ˜¾ç¤º API ä¸æ”¯æŒçš„æç¤º

            // **é‡è¦æç¤º**: ä¸‹é¢çš„ä»£ç å—æ¨¡æ‹Ÿäº†APIè°ƒç”¨å’Œæ•°æ®å¤„ç†è¿‡ç¨‹ã€‚
            // å®é™…ä½¿ç”¨ ExchangeRate-API çš„å…è´¹è®¡åˆ’æ— æ³•è·å–å†å²æ•°æ®ã€‚
            // å¦‚æœæ‚¨æœ‰ä»˜è´¹å¯†é’¥ï¼Œéœ€è¦æ›¿æ¢è¿™é‡Œçš„é€»è¾‘ä¸ºçœŸå®çš„APIè°ƒç”¨ã€‚
            // çœŸå®çš„APIç«¯ç‚¹ç±»ä¼¼: https://v6.exchangerate-api.com/v6/YOUR_API_KEY/history/BASE/YYYY/MM/DD

            // æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ (ç”¨äºæ¼”ç¤º)
            const labels = [];
            const rates = [];
            const today = new Date();
            let baseRate = getExchangeRate(base, target); // ä½¿ç”¨å½“å‰æ±‡ç‡ä½œä¸ºåŸºå‡†

            // æ›´å¥å£®çš„ baseRate å¤„ç†
            if (isNaN(baseRate) || !isFinite(baseRate) || baseRate <= 0) {
                console.warn(`æ— æ³•è·å–æœ‰æ•ˆçš„å½“å‰æ±‡ç‡ (${base}/${target}) ä½œä¸ºå†å²å›¾è¡¨åŸºå‡†ï¼Œå›¾è¡¨å¯èƒ½ä¸å‡†ç¡®ã€‚å°†ä½¿ç”¨é»˜è®¤å€¼ 1ã€‚`);
                baseRate = 1; // è®¾ç½®ä¸€ä¸ªé»˜è®¤åŸºå‡†é¿å…åç»­è®¡ç®—é”™è¯¯
            }
            console.log(`Using baseRate ${baseRate} for simulation.`); // Log the base rate used

           // ç®€å•çš„ä¼ªéšæœºç§å­ç”Ÿæˆå‡½æ•° (åŸºäºå­—ç¬¦ä¸²)
           const pseudoRandomSeed = (str) => {
               let hash = 0;
               for (let i = 0; i < str.length; i++) {
                   const char = str.charCodeAt(i);
                   hash = ((hash << 5) - hash) + char;
                   hash |= 0; // Convert to 32bit integer
               }
               return hash;
           };

           for (let i = days - 1; i >= 0; i--) {
               const date = new Date(today);
               date.setDate(today.getDate() - i);
               const formattedDate = date.toISOString().split('T')[0]; // YYYY-MM-DD
               labels.push(formattedDate);

               // ä½¿ç”¨åŸºäºæ—¥æœŸå’Œè´§å¸å¯¹çš„ç¨³å®šç§å­ç”Ÿæˆä¼ªéšæœºæ³¢åŠ¨
               const seedString = `${formattedDate}-${base}-${target}`;
               const seed = pseudoRandomSeed(seedString);
               // å°†ç§å­è½¬æ¢ä¸º -0.5 åˆ° 0.5 èŒƒå›´å†…çš„å€¼ (ç®€å•æ–¹å¼)
               const pseudoRandomValue = (seed % 1000) / 1000 - 0.5;
               const fluctuation = pseudoRandomValue * 0.1 * baseRate; // +/- 5% æ³¢åŠ¨å¹…åº¦ä¸å˜

               const simulatedRate = baseRate + fluctuation;
               // Ensure rate is a valid number and push
               const finalRate = simulatedRate > 0 ? simulatedRate : baseRate * 0.95;
                if (isNaN(finalRate) || !isFinite(finalRate)) {
                    console.error(`Generated invalid rate for date ${formattedDate}: ${finalRate}. Using baseRate instead.`);
                    rates.push(baseRate); // Fallback to baseRate if simulation yields invalid number
                } else {
                   rates.push(finalRate);
                }
           }
            // Log final generated data before validation
            console.log("Final generated simulated data before validation:", { labels, rates });


            // --- çœŸå® API è°ƒç”¨é€»è¾‘ (éœ€è¦ä»˜è´¹å¯†é’¥ï¼Œæ³¨é‡Šæ‰) ---
            /*  <-- Start the multi-line comment correctly
            const apiKey = USER_API_KEY; // ä½¿ç”¨æ‚¨è‡ªå·±çš„ä»˜è´¹ API å¯†é’¥
            const promises = [];
            const labels = [];
            const rates = [];
            const today = new Date();

            if (!apiKey || apiKey === 'YOUR_API_KEY_HERE') { // æ£€æŸ¥æ˜¯å¦æ˜¯ä»˜è´¹å¯†é’¥
                 console.error("éœ€è¦æœ‰æ•ˆçš„ä»˜è´¹ API å¯†é’¥æ‰èƒ½è·å–å†å²æ±‡ç‡ã€‚");
                 chartApiNotice.style.display = 'block';
                 return null; // æ— æ³•è·å–æ•°æ®
            } else {
                 chartApiNotice.style.display = 'none'; // å¦‚æœæœ‰å¯†é’¥ï¼Œéšè—æç¤º
            }


            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                labels.push(formattedDate);

                // æ³¨æ„: å†å²APIé€šå¸¸è¿”å›åŸºäºåŸºç¡€è´§å¸çš„æ‰€æœ‰æ±‡ç‡ï¼Œéœ€è¦ä»ä¸­æå–ç›®æ ‡è´§å¸
                // const url = `https://v6.exchangerate-api.com/v6/${apiKey}/history/${base}/${year}/${month}/${day}`;
                // promises.push(fetch(url).then(res => res.json()));

                 // å¦ä¸€ç§å¯èƒ½çš„API (exchangerate.host - å¯èƒ½å…è´¹ä½†æœ‰é™åˆ¶)
                 const url = `https://api.exchangerate.host/${formattedDate}?base=${base}&symbols=${target}`;
                 promises.push(fetch(url).then(res => res.json()));
            }

            try {
                const results = await Promise.all(promises);
                results.forEach((data, index) => {
                     // å¤„ç† ExchangeRate-API çš„å†å²æ•°æ®ç»“æ„ (å¦‚æœä½¿ç”¨)
                     // if (data && data.result === 'success' && data.conversion_rates && data.conversion_rates[target]) {
                     //     rates.push(data.conversion_rates[target]);
                     // }
                     // å¤„ç† exchangerate.host çš„æ•°æ®ç»“æ„ (å¦‚æœä½¿ç”¨)
                     if (data && data.success && data.rates && data.rates[target]) {
                         rates.push(data.rates[target]);
                     } else {
                        console.warn(`æœªèƒ½è·å– ${labels[index]} çš„æ±‡ç‡æ•°æ®:`, data);
                        rates.push(null); // æˆ–è€…å‰ä¸€å¤©çš„æ•°æ® rates[rates.length-1 || 0]
                    }
                });

                 // è¿‡æ»¤æ‰ null å€¼ï¼Œæˆ–è€…è¿›è¡Œæ’å€¼å¤„ç†
                const validRates = rates.filter(r => r !== null);
                const validLabels = labels.filter((_, idx) => rates[idx] !== null);

                 if (validRates.length === 0) {
                     console.error("æœªèƒ½è·å–ä»»ä½•æœ‰æ•ˆçš„å†å²æ±‡ç‡æ•°æ®ã€‚");
                     return null;
                 }


                return { labels: validLabels, rates: validRates };

            } catch (error) {
                console.error('è·å–å†å²æ±‡ç‡æ—¶å‡ºé”™:', error);
                showToast('è·å–å†å²æ±‡ç‡å¤±è´¥', 'error');
                return null;
            }
            */ // <-- End the multi-line comment correctly
            // --- ç»“æŸçœŸå® API è°ƒç”¨é€»è¾‘ ---

            // è¿”å›æ¨¡æ‹Ÿæ•°æ®å‰å†æ¬¡æ£€æŸ¥æœ‰æ•ˆæ€§
            if (!Array.isArray(labels) || !Array.isArray(rates) || labels.length !== rates.length || labels.length === 0) {
                 console.error("æ¨¡æ‹Ÿå†å²æ•°æ®ç”Ÿæˆå¤±è´¥ã€æ•°æ®ä¸åŒ¹é…æˆ–ä¸ºç©ºã€‚", { labels, rates });
                 return null; // Indicate failure
             }
             console.log("æˆåŠŸç”Ÿæˆå¹¶éªŒè¯æ¨¡æ‹Ÿå†å²æ•°æ®");
            return { labels, rates }; // è¿”å›æ¨¡æ‹Ÿæ•°æ®
        }

        // æ›´æ–°æˆ–ç»˜åˆ¶å›¾è¡¨
        async function updateChart() {
            console.log("Attempting to update chart..."); // Log start
            // ç¡®ä¿å…³é”® DOM å…ƒç´ å­˜åœ¨
            if (!historyChartCanvas || !chartCurrencyPairSpan || !chartApiNotice) {
                console.error("Chart related DOM elements (canvas, span, notice) not found!");
                return;
            }

            const fromCurrency = fromCurrencySelect.value;
            const toCurrency = toCurrencySelect.value;
             console.log(`Chart currencies: From ${fromCurrency}, To ${toCurrency}`);

            if (!fromCurrency || !toCurrency || fromCurrency === toCurrency) {
                console.log("Invalid or same currency pair, hiding chart.");
                if (historyChart) {
                    historyChart.destroy();
                    historyChart = null;
                     console.log("Destroyed existing chart instance.");
                }
                 historyChartCanvas.style.display = 'none';
                 chartCurrencyPairSpan.textContent = '';
                 // Hide API notice if chart is hidden due to same currency or no input
                 if(chartApiNotice) chartApiNotice.style.display = 'none';
                return;
            }
            // åªæœ‰åœ¨æŒ‰é’®ç‚¹å‡»åæ‰æ˜¾ç¤ºå›¾è¡¨åŒºåŸŸ
            const chartSection = document.querySelector('.chart-section');
            if (chartSection) chartSection.style.display = 'block';

             // Try showing canvas early, but check element exists
             historyChartCanvas.style.display = 'block';
             chartCurrencyPairSpan.textContent = `${fromCurrency}/${toCurrency}`;
             console.log("Set chart title span.");

            showChartLoading(true); // Show loading indicator

            let historicalData = null;
            try {
                 historicalData = await fetchHistoricalRates(fromCurrency, toCurrency);
                 console.log("Fetched historical data:", historicalData);
            } catch (error) {
                console.error("Error fetching historical rates:", error);
                showToast("è·å–å›¾è¡¨æ•°æ®æ—¶å‡ºé”™", "error");
                 showChartLoading(false);
                // Optionally hide chart canvas on fetch error
                 historyChartCanvas.style.display = 'none';
                 chartApiNotice.textContent = "è·å–å›¾è¡¨æ•°æ®å¤±è´¥ã€‚";
                 chartApiNotice.style.display = 'block';
                return;
            }

            showChartLoading(false); // Hide loading indicator

            if (!historicalData || !historicalData.labels || !historicalData.rates || historicalData.rates.length === 0) {
                console.warn("No valid historical data received to draw chart.");
                 if (historyChart) {
                     historyChart.destroy(); // Clean up existing chart
                     historyChart = null;
                     console.log("Destroyed existing chart instance due to no/invalid data.");
                 }
                  historyChartCanvas.style.display = 'none'; // Hide canvas if no data
                  chartApiNotice.textContent = "æ— æ³•åŠ è½½å›¾è¡¨æ•°æ®ã€‚"; // Show specific message
                  chartApiNotice.style.display = 'block';
                return;
            } else {
                 historyChartCanvas.style.display = 'block'; // Ensure canvas is visible if data exists
                 // Manage API notice visibility based on data source/validity
                 if (chartApiNotice.textContent.includes("å…è´¹API")) {
                      // Keep the API limitation notice visible
                      chartApiNotice.style.display = 'block';
                 } else {
                      // Hide other notices like "æ— æ³•åŠ è½½" if data is now present
                      chartApiNotice.style.display = 'none';
                 }
            }

            const { labels, rates } = historicalData;
            // Final check for data validity before creating chart data object
            if (!Array.isArray(labels) || !Array.isArray(rates) || rates.some(isNaN) || rates.some(r => !isFinite(r))) {
                 console.error("Invalid data received by chart renderer:", { labels, rates });
                 showToast("å›¾è¡¨æ•°æ®æ— æ•ˆ", "error");
                 historyChartCanvas.style.display = 'none'; // Hide canvas if data is bad
                 if (historyChart) { historyChart.destroy(); historyChart = null; }
                 return;
            }
            console.log("Processing valid chart data:", { labels, rates });

            const chartData = {
                labels: labels,
                datasets: [{
                    label: `1 ${fromCurrency} = X ${toCurrency}`,
                    data: rates,
                    fill: false, // Don't fill area under the line
                    borderColor: '#4CAF50', // Ensure this is a visible color
                    backgroundColor: '#4CAF50', // Added for point color, etc.
                    borderWidth: 2, // Make line slightly thicker
                    pointRadius: 3, // Show points slightly
                    tension: 0.1 // Keep slight curve
                }]
            };
            console.log("Chart.js chartData object:", JSON.stringify(chartData)); // Log the final data structure

            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true, // Allow responsiveness within the container
                    maintainAspectRatio: false, // Force chart to fill container dimensions
                    scales: {
                        y: { // Keep only one y-axis configuration
                            beginAtZero: false, // Yè½´ä¸ä¸€å®šä»0å¼€å§‹
                             ticks: {
                                 callback: function(value, index, values) {
                                     return formatNumber(value); // ä½¿ç”¨ç°æœ‰æ ¼å¼åŒ–å‡½æ•°
                                 }
                             }
                        }
                    },
                    // Removed duplicate y-axis block
                    plugins: {
                        legend: {
                            display: true // æ˜¾ç¤ºå›¾ä¾‹
                        },
                        tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) { label += ': '; }
                                     if (context.parsed.y !== null) {
                                         label += formatNumber(context.parsed.y) + ` ${toCurrency}`;
                                     }
                                     return label;
                                 }
                             }
                        }
                    }
                }
            };
            console.log("Chart.js config object:", JSON.stringify(config)); // Log the config object

            try {
                 console.log("Attempting to create or update Chart.js instance...");
                 if (historyChart) {
                     console.log("Updating existing chart instance.");
                     historyChart.data = chartData; // Update data
                     // It's often better to update options selectively or ensure full update if needed
                     // historyChart.options = config.options; // Re-assigning options might reset some state
                     historyChart.update(); // Update the chart
                      console.log("Chart instance updated.");
                 } else {
                     console.log("Creating new chart instance.");
                     if (historyChartCanvas instanceof HTMLCanvasElement) {
                        // Destroy any lingering instance just in case
                        // Chart.getChart(historyChartCanvas)?.destroy();
                        historyChart = new Chart(historyChartCanvas, config);
                        console.log("New chart instance created.");
                     } else {
                        console.error("historyChartCanvas is not a valid Canvas element during creation!");
                        throw new Error("Invalid canvas element for chart.");
                     }
                 }
                 // Ensure canvas is visible after successful draw/update
                 historyChartCanvas.style.display = 'block';
                 historyChartCanvas.style.visibility = 'visible';
                 console.log("Chart drawn/updated successfully.");
            } catch (error) { // Add the missing catch block
                console.error("Error creating or updating Chart.js instance:", error);
                showToast("ç»˜åˆ¶å›¾è¡¨æ—¶å‡ºé”™", "error");
                 // Attempt to clean up if creation failed
                 if (historyChart) {
                     try { historyChart.destroy(); } catch (e) { console.error("Error destroying chart:", e); }
                     historyChart = null;
                 }
                 historyChartCanvas.style.display = 'none'; // Hide canvas on error
                 chartApiNotice.textContent = "ç»˜åˆ¶å›¾è¡¨å¤±è´¥ã€‚";
                 chartApiNotice.style.display = 'block';
            } // End of the correct catch block
        } // End of updateChart function

        // æ˜¾ç¤ºå›¾è¡¨åŠ è½½çŠ¶æ€çš„å‡½æ•°
        function showChartLoading(isLoading) {
           const indicator = document.getElementById('chart-loading-indicator');
           if (indicator) {
                indicator.style.display = isLoading ? 'block' : 'none';
           }
           // åŠ è½½æ—¶éšè— canvas æœ¬èº«é¿å…çœ‹åˆ°æ—§å›¾è¡¨
           if (historyChartCanvas) { // ç¡®ä¿ canvas å…ƒç´ å­˜åœ¨
               historyChartCanvas.style.visibility = isLoading ? 'hidden' : 'visible';
           }
        }


   </script>
    <style>
        /* æ·»åŠ  Toast æ ·å¼ */
        .toast-success { background: #4CAF50; }
        .toast-error { background: #f44336; }
        .toast-warning { background: #ff9800; }

        /* æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        #loading-indicator {
            display: none; /* é»˜è®¤éšè— */
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #666;
        }
         /* æ·»åŠ æ±‡ç‡æ›´æ–°æ—¶é—´æˆ³æ ·å¼ */
        #rates-timestamp {
            display: none; /* é»˜è®¤éšè— */
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: -10px; /* è°ƒæ•´ä½ç½® */
            margin-bottom: 20px; /* å¢åŠ ä¸‹è¾¹è· */
        }
    </style>
    <!-- åŠ è½½æŒ‡ç¤ºå™¨å’Œæ—¶é—´æˆ³å·²è¢«ç§»å…¥ container -->
</body>
</html>